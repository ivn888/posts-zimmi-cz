<!DOCTYPE html>

<head>
  <meta charset="utf-8">
  <meta name="author" content="Michal Zimmermann">
  <meta name="description" content="Pieces of knowledge from the world of GIS." />
  <meta name="HandheldFriendly" content="True">
  <meta name="MobileOptimized" content="320">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <title> Michal Zimmermann  &mdash; Pieces of knowledge from the world of GIS. </title>
  <link rel="stylesheet" type="text/css" href="/posts//css/style.min.css" />
  <link href='http://fonts.googleapis.com/css?family=Roboto+Condensed:400,700' rel='stylesheet' type='text/css'>
  <script src="/posts//js/highlight.pack.js" defer></script>
  <script>
    window.onload = function() {
      var pre = document.getElementsByTagName('pre');
      for (var i = 0; i < pre.length; i += 1) {
        hljs.highlightBlock(pre[i].firstChild);
      }
    }
  </script>
</head>
<body>
    <div id="main" class="container">
        <div class="row">
            <header role="banner">
                <hgroup>
                    <h1><a href="/posts/">Michal Zimmermann</a></h1>
                    <strong>Pieces of knowledge from the world of GIS.</strong>
                </hgroup>
            </header>
            <nav role="navigation">
                <ul class="nav nav-pills main-navigation">
                    <li><a href="/posts/">Home</a></li>
                    <li><a href="/posts/categories/">Categories</a></li>
                    <li><a href="/posts/tags/">Tags</a></li>
                    <li><a href="/posts/feed.xml/">RSS</a></li>
                </ul>
            </nav>
        </div>
        <div class="shadow">
            <div class="row white">
                <div id="content">
                    <div class="blog-index">
                                                                        	<section>
			<article>
	<header>
	<h2><a href="/posts/2014/postgis-spatial-indexing-with-st-intersects/">PostGIS Spatial Indexing With ST_Intersects</a></h2>
	<small>Written on Nov 23, 2014
		and marked as
		<a href="/posts/tag/postgis/">postgis</a>				| <a href="/posts/category/SQL/">SQL</a>
		</small>
	</header>
	<section>
	<p><a href="http://postgis.net/docs/ST_Intersects.html">PostGIS docs</a> clearly states that:
    &gt; This function call will automatically include a bounding box comparison that will make use of any indexes that are available on the geometries.</p>
<p>That means (or at least I think so) that you shouldn&#8217;t bother with using <a href="http://postgis.net/docs/reference.html#Operators">operators</a> before calling this function.</p>
<p><a href="http://slides.com/michalzimmermann">I was preparing</a> my second lecture on PostGIS and I was experimenting a bit and came up with an interesting thing on this matter:</p>
<p>Let&#8217;s have two SQL relations, <code>roads</code> and <code>regions</code>. I would like to retrieve every road that intersects a certain region. Spatial indexes were built beforehand on both tables.</p>
<p>First try:</p>
<pre><code>EXPLAIN ANALYZE SELECT roads.* FROM roads
JOIN regions ON ST_Intersects(roads.geom, regions.geom)
WHERE regions."NAZEV" = 'Jihomoravský';`
</code></pre>
<p>And here comes the result:</p>
<pre><code>Nested Loop  (cost=4.85..324.26 rows=249 width=214) (actual time=45.102..5101.472 rows=74253 loops=1)
-&gt;  Seq Scan on regions  (cost=0.00..12.62 rows=1 width=32) (actual time=0.015..0.018 rows=1 loops=1)
     Filter: (("NAZEV")::text = 'Jihomoravský'::text)
     Rows Removed by Filter: 13
-&gt;  Bitmap Heap Scan on roads  (cost=4.85..311.38 rows=25 width=214) (actual time=45.079..4931.495 rows=74253 loops=1)
     Recheck Cond: (geom &amp;&amp; regions.geom)
     Rows Removed by Index Recheck: 154841
     Filter: _st_intersects(geom, regions.geom)
     Rows Removed by Filter: 71212
     -&gt;  Bitmap Index Scan on roads_idx  (cost=0.00..4.85 rows=75 width=0) (actual time=40.142..40.142 rows=145465 loops=1)
           Index Cond: (geom &amp;&amp; regions.geom)
Total runtime: 5181.459 ms
</code></pre>
<p>I was pretty satisfied with the result, I kept digging deeper though.</p>
<p>Second try:</p>
<pre><code>EXPLAIN ANALYZE SELECT roads.* FROM roads
JOIN regions ON roads.geom &amp;&amp; regions.geom
WHERE regions."NAZEV" = 'Jihomoravský' AND ST_Intersects(roads.geom, regions.geom);
</code></pre>
<p>And the result:</p>
<pre><code>Nested Loop  (cost=0.29..21.19 rows=1 width=214) (actual time=3.041..3850.302 rows=74253 loops=1)
-&gt;  Seq Scan on regions  (cost=0.00..12.62 rows=1 width=32) (actual time=0.021..0.024 rows=1 loops=1)
     Filter: (("NAZEV")::text = 'Jihomoravský'::text)
     Rows Removed by Filter: 13
-&gt;  Index Scan using roads_idx on roads  (cost=0.29..8.55 rows=1 width=214) (actual time=2.938..3681.432 rows=74253 loops=1)
     Index Cond: ((geom &amp;&amp; regions.geom) AND (geom &amp;&amp; regions.geom))
     Filter: _st_intersects(geom, regions.geom)
     Rows Removed by Filter: 71212
Total runtime: 3930.270 ms
</code></pre>
<p>Now there&#8217;s a significant difference between total runtimes of both queries and - more important - also a difference between their query plans. The latter is like <strong>20 % faster</strong>.</p>
<p>I&#8217;m puzzled about this behavior and would appreciate any thoughts on this. Reach me at <a href="http://twitter.com/zimmicz">Twitter</a>, <a href="https://www.linkedin.com/pub/michal-zimmermann/29/8/b30">LinkedIn</a> or e-mail (zimmicz[at]gmail.com).</p>
	</section>
</article>			<article>
	<header>
	<h2><a href="/posts/2014/bash-prepend-to-filename/">Bash: Prepend To Filename</a></h2>
	<small>Written on Nov 01, 2014
		and marked as
		<a href="/posts/tag/linux/">linux</a>, 		<a href="/posts/tag/bash/">bash</a>				| <a href="/posts/category/development/">development</a>
		</small>
	</header>
	<section>
	<pre><code>for f in *; do mv "$f" "prepend_$f"; done
</code></pre>
<p>Whenever you need to prepend anything to your files.</p>
	</section>
</article>			<article>
	<header>
	<h2><a href="/posts/2014/migrating-geoserver-and-checking-for-missing-data/">Migrating Geoserver And Checking For Missing Data</a></h2>
	<small>Written on Oct 29, 2014
		and marked as
		<a href="/posts/tag/geoserver/">geoserver</a>, 		<a href="/posts/tag/python/">python</a>				| <a href="/posts/category/development/">development</a>
		</small>
	</header>
	<section>
	<p>I&#8217;ve upgraded a handful of Geoserver installations and it has never been flawless. If you&#8217;re lucky you end up with just <em>some</em> layers missing, if you&#8217;re not, you&#8217;ll miss a bunch of them (together with layergroups, some stores, workspaces might screw up etc.).</p>
<p>But how do you check for missing data before switching to the newer version? Thanks to the <a href="http://docs.geoserver.org/stable/en/user/rest/api/index.html">REST API implemented within Geoserver</a>, it&#8217;s rather easy.</p>
<pre><code>import requests
from bs4 import BeautifulSoup
from requests.auth import HTTPBasicAuth

req = requests.get('http://example.com/geoserver/rest/layers', auth=HTTPBasicAuth('username', 'password'))

html = BeautifulSoup(req.text)
i = 0
for link in html.find_all('a'):
    i += 1
    href = link.get_text()
    print i

with open('list.txt', 'a') as f:
        f.write(href)
        f.write('\n')
</code></pre>
<p>We needed to migrate ~ 17,000 layers last week, and yes, we could have just shut the door and spend couple of nights checking one after another, if we were the dumbest GIS company ever.</p>
<p>As I wanted to make it a bit easier I wrote the simple Python script (see above) that just authenticates against Geoserver and downloads the list of layers. I actually had to do that twice - both old and new instance. A <a href="https://www.diffchecker.com/">simple file comparison</a> followed and I got a list of missing layers in less than two minutes.</p>
<p>If you do the same to workspaces, stores and layergroups, your chances of not losing some data after the switch are pretty high.</p>
<p>I guess it&#8217;s reasonable to check your maps by hand as well, but this gives you the picture of the current state of your data real quick.</p>
	</section>
</article>			<article>
	<header>
	<h2><a href="/posts/2014/ogr2ogr-unix-x-windows/">ogr2ogr UNIX x Windows</a></h2>
	<small>Written on Sep 23, 2014
		and marked as
		<a href="/posts/tag/spatial/">spatial</a>, 		<a href="/posts/tag/linux/">linux</a>				| <a href="/posts/category/development/">development</a>
		</small>
	</header>
	<section>
	<p>GDAL with its ogr2ogr, ogrinfo and many more is one of the best open source tools to do anything to your spatial data. It is a&nbsp;command line tool, which sort of determines it to be used with UNIX systems, but you might bump into a Windows guy trying to use it as well once in a while.</p>
<p>Be careful, it behaves differently on different OS. Let&#8217;s say you do something like this on UNIX:</p>
<pre><code>ogr2ogr -f GeoJSON -where "attribute IN ('value1', 'value2')" output.json input.json
</code></pre>
<p>What you <abbr title="But you might get expected result as well">might get is a big nothing</abbr>. Executed on Windows it gives you the result you&#8217;ve expected. <em>Aargh</em>, what is that supposed to mean?</p>
<p>Well, that&#8217;s the ogr2ogr&#8217;s way to tell you: <em>Hello there, you need to switch single quotes for double quotes and vice versa, you dumb!</em> I don&#8217;t know why and I find it really annoying. Just in case you get stuck with ogr2ogr (or probably any other command line tool), try this.</p>
	</section>
</article>			<article>
	<header>
	<h2><a href="/posts/2014/notify-when-average-of-10-subsequent-numbers-is-bigger-than-given-value/">Notify When Average of 10 Subsequent Numbers Is Bigger Than Given Value</a></h2>
	<small>Written on Sep 21, 2014
		and marked as
		<a href="/posts/tag/php/">php</a>				| <a href="/posts/category/development/">development</a>
		</small>
	</header>
	<section>
	<p>I found an <a href="http://stackoverflow.com/questions/25952380/php-find-a-maximum-average-for-10-subsequent-numbers-in-a-list-of-50-random-numb">interesting question</a> at StackOverflow asking for help finding solution to what I have already mentioned in the title, with PHP. I gave it a try before reading answers and came up with the following code:</p>
<pre><code>$avg  = // value we are looking for
$size = count($numbers);

for ($i = 0; $i &lt; $size; $i += 1) {
    if ($i + 9 &lt; 51) {
        $val += $numbers[$i];
        for ($j = $i + 1; $j &lt; 10 + $i; $j += 1) {
            $val += $numbers[$j];
        }
        if ($val / 10 &gt;= $avg) { // hit
            // do something
        }
        $val = 0;
    }
}
</code></pre>
<p>That was the first that I could think of. And it worked. The answer given by Dave Chen was much more elegant than my solution (although I think it does something a bit different, but that&#8217;s not the point here):</p>
<pre><code>$number = 10; //numbers in a set
$max = 0;
$index = 0;

$size = sizeof($numbers) - $number;
for ($i = 0; $i &lt; $size; $i++) {
    $tmp = array_sum(array_slice($numbers, $i, $number)) / $number;
    if ($tmp &gt; $max) {
        $max = $tmp;
        $index = $i;
    }
}
</code></pre>
<p>I made a simple benchmark with <a href="http://php.net/manual/en/function.microtime.php"><code>microtime()</code></a> and found out that my solution (ran 100k times) took about ~12.3 seconds while Dave&#8217;s took only ~7.4 seconds to finish. That makes his code almost twice faster than mine.</p>
<p><strong>Lesson learned: do not stop learning!</strong></p>
	</section>
</article>			<article>
	<header>
	<h2><a href="/posts/2014/postgresql-remote-access/">PostgreSQL Remote Access</a></h2>
	<small>Written on Sep 17, 2014
		and marked as
		<a href="/posts/tag/postgresql/">postgresql</a>, 		<a href="/posts/tag/linux/">linux</a>				| <a href="/posts/category/development/">development</a>
		</small>
	</header>
	<section>
	<p>PostgreSQL is set to listen only to connections coming from localhost by default. I guess that&#8217;s fine as far as you don&#8217;t need access to the database from anywhere else (like your work network). If you do, you need to log via SSH or use some online database management tool (go for <a href="http://adminer.org">Adminer</a> and forget about anything called php[pg|my]admin). Or you can set it up to access connections from other locations.</p>
<p>You need to:</p>
<ol>
<li>set <code>listen_addresses</code> to <code>*</code> in your postgres.conf. That does not mean anyone can connect to your database, that means that the server will listen to connections coming from any available IP interface.</li>
<li>insert new entry into pg_hba.conf looking like this: <code>host database user xxx.xxx.xxx.xxx md5</code>. Now we&#8217;re saying we only want connections coming from IP <code>xxx.xxx.xxx.xxx</code> accepted.</li>
<li>
<p>Add rule allowing the database server access to iptables. Number 5 says it will be the fifth rule in the order. It must come before the final REJECT ALL rule if present.</p>
<p><code>iptables -I INPUT 5 -p tcp --dport 5432 -s xxx.xxx.xxx.xxx -j ACCEPT</code>
4. Just to be sure noone else is able to connect, reject all on port 5432.</p>
<p><code>iptables -I INPUT 6 -p tcp --dport 5432 -j REJECT</code></p>
</li>
</ol>
<p>You&#8217;re set to remotely connect to your database server.</p>
	</section>
</article>			<article>
	<header>
	<h2><a href="/posts/2014/switch-latitude-and-longitude-with-regular-expression/">Switch Latitude And Longitude With Regular Expression</a></h2>
	<small>Written on Sep 14, 2014
		and marked as
		<a href="/posts/tag/sublime/">sublime</a>, 		<a href="/posts/tag/regex/">regex</a>				| <a href="/posts/category/development/">development</a>
		</small>
	</header>
	<section>
	<p>It happens that you receive a file with longitude and latitude just in the opposite order that you would like to have. It&#8217;s fairly easy to switch those without loading it into Excel or Calc and doing <code>Ctrl + C</code> and <code>Ctrl + V</code> on columns.</p>
<p>If you have a file with tabular data that looks like this:</p>
<pre><code> 50.52, 60.15
 70.96, 80.1
-55.23, 62.03
</code></pre>
<p>You can use Sublime Text to switch the values:</p>
<ol>
<li>Press <code>Ctrl + H</code></li>
<li>Copy <code>(\-?\d+\.?\d+),?[\t ]*(\-?\d+\.?\d+)$</code> to <em>Find What</em> input</li>
<li>Copy <code>$2,$1</code> to <em>Replace With</em> input</li>
</ol>
<p>Hit <em>Replace All</em> button and you&#8217;re done.</p>
	</section>
</article>			<article>
	<header>
	<h2><a href="/posts/2014/connecting-to-secured-arcgis-server-layer-with-openlayers-3/">Connecting To Secured ArcGIS Server Layer With OpenLayers 3</a></h2>
	<small>Written on Sep 12, 2014
		and marked as
		<a href="/posts/tag/javascript/">javascript</a>, 		<a href="/posts/tag/openlayers/">openlayers</a>, 		<a href="/posts/tag/ogc/">ogc</a>				| <a href="/posts/category/web maps/">web maps</a>
		</small>
	</header>
	<section>
	<p>I was made to use ArcGIS Server with <a href="http://openlayers.org">Openlayers 3</a> just recently as one of the projects I&#8217;ve been working on demands such different tools to work together. </p>
<p><strong>tl;dr: I hate Esri.</strong></p>
<p>I found myself in need to access secured layers published via WMS on ArcGIS Server using username and password I was given, so here&#8217;s a little how-to for anyone who would have to do the same.</p>
<p>Let&#8217;s start with a simple ol.layer.Image and pretend this is the secured layer we&#8217;re looking for:</p>
<pre><code>var layer = new ol.layer.Image({
    extent: extent,
    source: new ol.source.ImageWMS(/** @type {olx.source.ImageWMSOptions} */ ({
        url: url,
        params: {
            'LAYERS': 'layer',
            'CRS': 'EPSG:3857',
        }
    }))
});
</code></pre>
<p>We need to retrieve the token, so we define a function:</p>
<pre><code>function retrieveToken(callback) {
    var req = new XMLHttpRequest;

    req.onload = function() {
        if (req.status == "200") {
            var response = JSON.parse(req.responseText);
            if (response.contents) {
                callback(response.contents); // response contents is where the token is stored
        }
    };
    req.open("get", "http://server.address/arcgis/tokens/?request=getToken&amp;username=username&amp;password=password&amp;expiration=60", true);
    req.send()
}
</code></pre>
<p>I pass a parameter called <code>callback</code> - that&#8217;s a very important step, otherwise you would not be able to retrieve the token when you actually need it (AJAX stands for asynchronous). Now you just pass the token to the layer params like this:</p>
<pre><code>retrieveToken(function(token) {
    layer.getSource().updateParams({
        token: token
    })
}
</code></pre>
<p>When you open Firebug and inspect Network tab, you should find <code>token</code> URL parameter passed along with WMS <code>GetMap</code> request.</p>
<p>Few sidenotes:</p>
<ol>
<li>Although you might be logged in ArcGIS Server via web interface, you might need to pass the <code>token</code>  URL param when trying to access Capabilities document. Don&#8217;t know why though.</li>
<li>You should probably take care of calling the <code>retrieveToken()</code> in shorter interval than the token expiration is set to. Otherwise you might end up with invalid token.</li>
<li>You need to hide the username and password from anonymous users (I guess that&#8217;s only possible with server side implementation of selective JavaScript loading).</li>
</ol>
	</section>
</article>			<article>
	<header>
	<h2><a href="/posts/2014/blogging-on-docker-piecrust-to-the-rescue/">Blogging On Docker: Piecrust To The Rescue</a></h2>
	<small>Written on Sep 11, 2014
		and marked as
		<a href="/posts/tag/docker/">docker</a>, 		<a href="/posts/tag/linux/">linux</a>				| <a href="/posts/category/development/">development</a>
		</small>
	</header>
	<section>
	<p>I love blogging. I hate blogging systems. I hate content management systems. I just want to blog. That&#8217;s what <a href="http://bolt80.com/piecrust/">PieCrust</a> is all about - it lets you blog.</p>
<p>It is powerful static website generator perfect for my needs (and for yours as well?). Blogging with PieCrust is really a piece of cake:</p>
<ol>
<li>prepare post</li>
<li>serve site</li>
<li>bake site</li>
<li>send it off to the public</li>
</ol>
<p>I love having clean OS. That&#8217;s what <a href="http://docker.com">Docker</a> is all about - for me. Running PieCrust on Docker is really easy, it does not clutter your PC and it just works.</p>
<p>If you ever want to use PieCrust on Docker, why don&#8217;t you start with this code?
    FROM centos:centos6</p>
<pre><code>RUN rpm -Uvh http://mirror.webtatic.com/yum/el6/latest.rpm
RUN rpm -Uvh http://download.fedoraproject.org/pub/epel/6/x86_64/epel-release-6-8.noarch.rpm
RUN rpm -Uvh http://rpms.famillecollet.com/enterprise/remi-release-6.rpm

RUN yum --enablerepo=remi,remi-php55 install -y php php-mbstring php-opcache php-cli php-pear php-common &amp;&amp; yum clean all
RUN php -r "readfile('https://getcomposer.org/installer');" | php
RUN echo "date.timezone = Europe/Prague" &gt;&gt; /etc/php.ini
RUN mv composer.phar /usr/bin/composer
RUN php -r "eval('?&gt;'.file_get_contents('http://backend.bolt80.com/piecrust/install'));"
RUN mv piecrust.phar /usr/bin/chef

CMD ["/bin/bash"]
</code></pre>
<p>Running <code>sudo docker build --tag=piecrust .</code> will result in having docker container ready to run. Just run <code>sudo docker run -it -p 8080:8080 -v /host_piecrust_path/:/container_path piecrust /bin/bash</code> in terminal. While in container terminal, run <code>chef serve -n -p 8080 -a 0.0.0.0</code> and visit <a href="http://localhost:8080">http://localhost:8080</a>. You should see your PieCrust site up and running.</p>
<p>The last command tells chef to serve your site on port 8080 (which should be free unless you&#8217;re running Tomcat or something like that) and make it listen on every available network interface. If you used 127.0.0.1 instead, you would never reach your site from outside the container.</p>
<p>See? Easy.</p>
	</section>
</article>			<article>
	<header>
	<h2><a href="/posts/2014/wmts-few-things-i-want-to-remember/">WMTS: Few Things I Want To Remember</a></h2>
	<small>Written on Sep 10, 2014
		and marked as
		<a href="/posts/tag/ogc/">ogc</a>, 		<a href="/posts/tag/wmts/">wmts</a>				| <a href="/posts/category/web maps/">web maps</a>
		</small>
	</header>
	<section>
	<ul>
<li>Used to serve prepared rectangular tiles; this means you are limited by web server speed rather than map server speed</li>
<li>Several ways to retrieve tiles are defined: KVP and REST are mandatory, SOAP is optional</li>
<li>Does not allow layer combination; additional tile matrix would have to be created</li>
<li>GetCapabilities, GetTile and GetFeatureInfo requests are defined</li>
<li><strong>tile</strong></li>
<li>rectangular representation of space</li>
<li>defined by tile and row indices</li>
<li><strong>tile matrix</strong></li>
<li>set of tiles for a given scale</li>
<li><em>defined with:</em><ul>
<li>tile size derived from standardized pixel size (0.28 &times; 0.28 mm)</li>
<li>tile width and tile height (px)</li>
<li>left upper corner coordinates</li>
<li>matrix width and height as number of tiles</li>
</ul>
</li>
<li><strong>tile matrix set</strong></li>
<li>set of tile matrices for different scales</li>
</ul>
<h3>Total count of tile matrices</h3>
<p><em><code>nTileMatrices × nTiledStyles × nTiledFormats (if no dimensions are defined)</code></em></p>
<h3>Total count of tiles in a tile matrix</h3>
<p><em><code>matrixWidth × matrixHeight</code></em></p>
<h3>Other equations</h3>
<ul>
<li><code>pixelSpan = scaleDenominator × 0.28 10<sup>3</sup> / metersPerUnit(crs);</code></li>
<li><code>tileSpanX = tileWidth × pixelSpan;</code></li>
<li><code>tileSpanY = tileHeight × pixelSpan;</code></li>
<li><code>tileMatrixMaxX = tileMatrixMinX + tileSpanX × matrixWidth;</code></li>
<li><code>tileMatrixMinY = tileMatrixMaxY - tileSpanY × matrixHeight;</code></li>
</ul>
<p><img src="/posts/2014/wmts-few-things-i-want-to-remember/wmts.png" title="WMTS tiling schema" class="img-responsive centered"></p>
	</section>
</article>		</section>

                                          </div>
                </div>
            </div>
            <div class="row white">
                <footer role="contentinfo">
                                                                  <a class="pagination" href="/posts/2/">&laquo; Previous page</a>
                      
                                              <a class="pagination" href="/posts/2/3">Next page &raquo;</a>
                                                              <p>Written by <a href="http://www.zimmi.cz">Michal Zimmermann</a>. Baked with <em><a href="http://bolt80.com/piecrust/">PieCrust</a> 2.0.0a6-6-g0fb1eb8</em>.</p>
                </footer>
            </div>
        </div>
    </div>
    <script>
      (function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
      (i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
      m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
      })(window,document,'script','//www.google-analytics.com/analytics.js','ga');

      ga('create', 'UA-43432739-2', 'auto');
      ga('send', 'pageview');
    </script>
</body>
</html>