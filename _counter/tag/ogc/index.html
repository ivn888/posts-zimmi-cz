<!DOCTYPE html>
<head>
  <meta charset="utf-8">
  <meta name="author" content="Michal Zimmermann">
  <meta name="description" content="Pieces of knowledge from the world of GIS." />
  <meta name="HandheldFriendly" content="True">
  <meta name="MobileOptimized" content="320">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <title> Michal Zimmermann  &mdash; Tag: ogc </title>
  <link rel="stylesheet" type="text/css" href="/posts/css/01_normalize.css" />
  <link rel="stylesheet" type="text/css" href="/posts/css/02_bootstrap.min.css" />
  <link rel="stylesheet" type="text/css" href="/posts/css/03_railscasts.css" />
  <link rel="stylesheet" type="text/css" href="/posts/css/04_screen.css" />
  <link href='http://fonts.googleapis.com/css?family=Roboto+Condensed:400,700' rel='stylesheet' type='text/css'>
  <script src="/posts/assets/js/highlight.pack.js" defer></script>
  <script>
    window.onload = function() {
      var pre = document.getElementsByTagName('pre');
      for (var i = 0; i < pre.length; i += 1) {
        hljs.highlightBlock(pre[i].firstChild);
      }
    }
  </script>
</head>
<body>
    <div id="main" class="container">
        <div class="row">
            <header role="banner">
                <hgroup>
                    <h1><a href="/posts/">Michal Zimmermann</a></h1>
                    <strong>Pieces of knowledge from the world of GIS.</strong>
                </hgroup>
            </header>
            <nav role="navigation">
                <ul class="nav nav-pills main-navigation">
                    <li><a href="/posts/">Home</a></li>
                    <li><a href="/posts/categories/">Categories</a></li>
                    <li><a href="/posts/tags/">Tags</a></li>
                    <li><a href="/posts/feed.xml/">RSS</a></li>
                </ul>
            </nav>
        </div>
        <div class="shadow">
            <div class="row white">
                <div id="content">
                    <div class="blog-index">
                                                                        <h1>Posts tagged with ogc</h1>
                                                  <section>
		<article>
	<header>
	<h2><a href="/posts/2015/wms-download-for-future-offline-use/">WMS Download For Future Offline Use</a></h2>
	<small>Written on Mar 15, 2015
		and marked as
		<a href="/posts/tag/ogc/">ogc</a>, 		<a href="/posts/tag/python/">python</a>, 		<a href="/posts/tag/wms/">wms</a>				| <a href="/posts/category/automation/">automation</a>
		</small>
	</header>
	<section>
	<p>Using WMS in real time might easily become pain in the ass due to low connection speed or slow server response. Downloading images beforehand seems to be a reasonable choice both to avoid any slowdowns and to improve user experience when working with WMS layers.</p>
<p><a href="https://geopython.github.io/OWSLib/">OWSLib</a> is a great tool to help you get images from WMS server. Code and some comments follow.</p>
<pre><code>import math
import os
import random
import time
from owslib.wms import WebMapService

BOTTOM_LEFT = (-679363,-1120688)
TOP_RIGHT   = (-565171,-1042703)
SRS_WIDTH   = math.fabs(-639084 - -638825) # tile width in units of crs =&gt; 259 m
SRS_HEIGHT  = math.fabs(-1070426 - -1070273) # tile height in units of crs =&gt; 153 m
PX_WIDTH    = 977
PX_HEIGHT   = 578

FORMAT      = 'image/png'
LAYERS      = ['KN', 'RST_PK']
SIZE        = (PX_WIDTH, PX_HEIGHT)
SRS         = 'EPSG:5514'
STYLES      = ['default', 'default']
TRANSPARENT = True

DIRECTORY = 'tiles/'
SLEEP     = random.randint(0,20) # seconds

dx = math.fabs(BOTTOM_LEFT[0] - TOP_RIGHT[0]) # area width in units of crs
dy = math.fabs(BOTTOM_LEFT[1] - TOP_RIGHT[1]) # area height in units of crs

cols = int(math.ceil(dx / SRS_WIDTH)) + 1
rows = int(math.ceil(dy / SRS_HEIGHT)) + 1

counter = 0

with open('world_file.pngw', 'r') as wld_template:
    tmpl = wld_template.read()

wms = WebMapService('http://services.cuzk.cz/wms/wms.asp', version='1.1.1')

for i in xrange(0, rows):
    if not os.path.exists(DIRECTORY + str(i)):
        os.mkdir(DIRECTORY + str(i))

    for j in xrange(0, cols):
        if os.path.exists(DIRECTORY + str(i) +'/kn_' + str(i) + '_' + str(j) + '.png'):
            counter += 1
            continue

        bbox = (
            i * SRS_WIDTH + BOTTOM_LEFT[0],
            j * SRS_HEIGHT + BOTTOM_LEFT[1],
            (i + 1) * SRS_WIDTH + BOTTOM_LEFT[0],
            (j + 1) * SRS_HEIGHT + BOTTOM_LEFT[1]
        )

        img = wms.getmap(
            layers=LAYERS,
            styles=STYLES,
            srs=SRS,
            bbox=bbox,
            size=SIZE,
            format=FORMAT,
            transparent=TRANSPARENT
        )

        with open(DIRECTORY + str(i) +'/kn_' + str(i) + '_' + str(j) + '.png', 'wb') as png:
            png.write(img.read())

        with open(DIRECTORY + str(i) + '/kn_' + str(i) + '_' + str(j) + '.pngw', 'w') as wld_file:
            wld_file.write(tmpl)
            wld_file.write('\n' + str(i * SRS_WIDTH + BOTTOM_LEFT[0]))
            wld_file.write('\n' + str((j+1) * SRS_HEIGHT + BOTTOM_LEFT[1]))

        counter += 1
        print str(counter), ' out of ', str(rows * cols)
        time.sleep(SLEEP)
</code></pre>
<p>First, always make sure <strong>you are not violating terms of use</strong> defined by service provider. If you are not, here are the necessary steps:</p>
<ol>
<li>Define your area of interest with bottom left and top right coordinates.</li>
<li>Calculate width of single image both in pixels and units of CRS to get the rightsized image. Note that there may be image size restrictions defined by provider (2048 &times; 2048 px is usually the biggest you can get).</li>
<li>Define template <a href="https://en.wikipedia.org/wiki/World_file">world file</a> for referencing images. OWSLib doesn&#8217;t provide world files to saved images, these have to be created by you. I recommend to use a template file for creating real world files.</li>
<li>Be nice! Don&#8217;t overload the service. I use <code>time.sleep()</code> for this.</li>
<li>Profit.</li>
</ol>
<p>The trouble with WMS is that you can&#8217;t set an arbitrary scale you want to obtain images in (e.g. 1:1 000). It&#8217;s fairly easy to get all values needed to imitate this behavior though.</p>
<p>Using <a href="http://qgis.org">QGIS</a> you can:</p>
<ol>
<li>Get bounding box of area you&#8217;re interested in.</li>
<li>Save current view as an image (together with the world file!) and use it as a specimen for your own world files.</li>
<li>Derive image width (CRS, pixels) from the saved image, thus getting the same zoom level you were using in QGIS.</li>
</ol>
<p>Code given is not bulletproof, it will fail on any network error. However, if you restart it after such a crash, it checks for existing files and starts with the first missing, so you don&#8217;t have to download all the tiles again.</p>
	</section>
</article>		<article>
	<header>
	<h2><a href="/posts/2014/connecting-to-secured-arcgis-server-layer-with-openlayers-3/">Connecting To Secured ArcGIS Server Layer With OpenLayers 3</a></h2>
	<small>Written on Sep 12, 2014
		and marked as
		<a href="/posts/tag/javascript/">javascript</a>, 		<a href="/posts/tag/openlayers/">openlayers</a>, 		<a href="/posts/tag/ogc/">ogc</a>				| <a href="/posts/category/web maps/">web maps</a>
		</small>
	</header>
	<section>
	<p>I was made to use ArcGIS Server with <a href="http://openlayers.org">Openlayers 3</a> just recently as one of the projects I&#8217;ve been working on demands such different tools to work together. </p>
<p><strong>tl;dr: I hate Esri.</strong></p>
<p>I found myself in need to access secured layers published via WMS on ArcGIS Server using username and password I was given, so here&#8217;s a little how-to for anyone who would have to do the same.</p>
<p>Let&#8217;s start with a simple ol.layer.Image and pretend this is the secured layer we&#8217;re looking for:</p>
<pre><code>var layer = new ol.layer.Image({
    extent: extent,
    source: new ol.source.ImageWMS(/** @type {olx.source.ImageWMSOptions} */ ({
        url: url,
        params: {
            'LAYERS': 'layer',
            'CRS': 'EPSG:3857',
        }
    }))
});
</code></pre>
<p>We need to retrieve the token, so we define a function:</p>
<pre><code>function retrieveToken(callback) {
    var req = new XMLHttpRequest;

    req.onload = function() {
        if (req.status == "200") {
            var response = JSON.parse(req.responseText);
            if (response.contents) {
                callback(response.contents); // response contents is where the token is stored
        }
    };
    req.open("get", "http://server.address/arcgis/tokens/?request=getToken&amp;username=username&amp;password=password&amp;expiration=60", true);
    req.send()
}
</code></pre>
<p>I pass a parameter called <code>callback</code> - that&#8217;s a very important step, otherwise you would not be able to retrieve the token when you actually need it (AJAX stands for asynchronous). Now you just pass the token to the layer params like this:</p>
<pre><code>retrieveToken(function(token) {
    layer.getSource().updateParams({
        token: token
    })
}
</code></pre>
<p>When you open Firebug and inspect Network tab, you should find <code>token</code> URL parameter passed along with WMS <code>GetMap</code> request.</p>
<p>Few sidenotes:</p>
<ol>
<li>Although you might be logged in ArcGIS Server via web interface, you might need to pass the <code>token</code>  URL param when trying to access Capabilities document. Don&#8217;t know why though.</li>
<li>You should probably take care of calling the <code>retrieveToken()</code> in shorter interval than the token expiration is set to. Otherwise you might end up with invalid token.</li>
<li>You need to hide the username and password from anonymous users (I guess that&#8217;s only possible with server side implementation of selective JavaScript loading).</li>
</ol>
	</section>
</article>		<article>
	<header>
	<h2><a href="/posts/2014/wmts-few-things-i-want-to-remember/">WMTS: Few Things I Want To Remember</a></h2>
	<small>Written on Sep 10, 2014
		and marked as
		<a href="/posts/tag/ogc/">ogc</a>, 		<a href="/posts/tag/wmts/">wmts</a>				| <a href="/posts/category/web maps/">web maps</a>
		</small>
	</header>
	<section>
	<ul>
<li>Used to serve prepared rectangular tiles; this means you are limited by web server speed rather than map server speed</li>
<li>Several ways to retrieve tiles are defined: KVP and REST are mandatory, SOAP is optional</li>
<li>Does not allow layer combination; additional tile matrix would have to be created</li>
<li>GetCapabilities, GetTile and GetFeatureInfo requests are defined</li>
<li><strong>tile</strong></li>
<li>rectangular representation of space</li>
<li>defined by tile and row indices</li>
<li><strong>tile matrix</strong></li>
<li>set of tiles for a given scale</li>
<li><em>defined with:</em><ul>
<li>tile size derived from standardized pixel size (0.28 &times; 0.28 mm)</li>
<li>tile width and tile height (px)</li>
<li>left upper corner coordinates</li>
<li>matrix width and height as number of tiles</li>
</ul>
</li>
<li><strong>tile matrix set</strong></li>
<li>set of tile matrices for different scales</li>
</ul>
<h3>Total count of tile matrices</h3>
<p><em><code>nTileMatrices × nTiledStyles × nTiledFormats (if no dimensions are defined)</code></em></p>
<h3>Total count of tiles in a tile matrix</h3>
<p><em><code>matrixWidth × matrixHeight</code></em></p>
<h3>Other equations</h3>
<ul>
<li><code>pixelSpan = scaleDenominator × 0.28 10<sup>3</sup> / metersPerUnit(crs);</code></li>
<li><code>tileSpanX = tileWidth × pixelSpan;</code></li>
<li><code>tileSpanY = tileHeight × pixelSpan;</code></li>
<li><code>tileMatrixMaxX = tileMatrixMinX + tileSpanX × matrixWidth;</code></li>
<li><code>tileMatrixMinY = tileMatrixMaxY - tileSpanY × matrixHeight;</code></li>
</ul>
<p><img src="/posts/2014/wmts-few-things-i-want-to-remember/wmts.png" title="WMTS tiling schema" class="img-responsive centered"></p>
	</section>
</article></section>
                                          </div>
                </div>
            </div>
            <div class="row white">
                <footer role="contentinfo">
                                          
                                                              <p>Written by <a href="http://www.zimmi.cz">Michal Zimmermann</a>. Baked with <em><a href="http://bolt80.com/piecrust/">PieCrust</a> 2.0.0a6-11-g296b35a</em>.</p>
                </footer>
            </div>
        </div>
    </div>
    <script>
      (function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
      (i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
      m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
      })(window,document,'script','//www.google-analytics.com/analytics.js','ga');

      ga('create', 'UA-43432739-2', 'auto');
      ga('send', 'pageview');
    </script>
</body>
</html>