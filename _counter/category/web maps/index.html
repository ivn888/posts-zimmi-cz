<!DOCTYPE html>
<head>
  <meta charset="utf-8">
  <meta name="author" content="Michal Zimmermann">
  <meta name="description" content="Pieces of knowledge from the world of GIS." />
  <meta name="HandheldFriendly" content="True">
  <meta name="MobileOptimized" content="320">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <title> Michal Zimmermann  &mdash; Category: web maps </title>
  <link rel="stylesheet" type="text/css" href="/posts/css/01_normalize.css" />
  <link rel="stylesheet" type="text/css" href="/posts/css/02_bootstrap.min.css" />
  <link rel="stylesheet" type="text/css" href="/posts/css/03_railscasts.css" />
  <link rel="stylesheet" type="text/css" href="/posts/css/04_screen.css" />
  <link href='http://fonts.googleapis.com/css?family=Roboto+Condensed:400,700' rel='stylesheet' type='text/css'>
  <script src="/posts/assets/js/highlight.pack.js" defer></script>
  <script>
    window.onload = function() {
      var pre = document.getElementsByTagName('pre');
      for (var i = 0; i < pre.length; i += 1) {
        hljs.highlightBlock(pre[i].firstChild);
      }
    }
  </script>
</head>
<body>
    <div id="main" class="container">
        <div class="row">
            <header role="banner">
                <hgroup>
                    <h1><a href="/posts/">Michal Zimmermann</a></h1>
                    <strong>Pieces of knowledge from the world of GIS.</strong>
                </hgroup>
            </header>
            <nav role="navigation">
                <ul class="nav nav-pills main-navigation">
                    <li><a href="/posts/">Home</a></li>
                    <li><a href="/posts/categories/">Categories</a></li>
                    <li><a href="/posts/tags/">Tags</a></li>
                    <li><a href="/posts/feed.xml/">RSS</a></li>
                </ul>
            </nav>
        </div>
        <div class="shadow">
            <div class="row white">
                <div id="content">
                    <div class="blog-index">
                                                                        <h1>Posts in category web maps</h1>
                                                  <section>
		<article>
	<header>
	<h2><a href="/posts/2015/animating-svg-maps-with-smil/">Animating SVG Maps With SMIL</a></h2>
	<small>Written on Apr 29, 2015
		and marked as
		<a href="/posts/tag/svg/">svg</a>, 		<a href="/posts/tag/smil/">smil</a>				| <a href="/posts/category/web maps/">web maps</a>
		</small>
	</header>
	<section>
	<p>Using SVG to build web maps have both pros and cons and to be honest I don&#8217;t know any <em>serious</em> map/GIS project built on top of SVG. However, as a part of my job at university, I was forced to use both SVG and SMIL to produce animated web map (see the small version below or the big one at <a href="https://zimmicz.github.io/svg-smil-airplanes/map.svg">GitHub</a>) and I&#8217;d like to share my findings.</p>
<p><object width="400" data="https://zimmicz.github.io/svg-smil-airplanes/map.svg" type="image/svg+xml"></object></p>
<h2>Data preprocessing</h2>
<p>I chose <a href="http://www.naturalearthdata.com/">Natural Earth dataset</a> both for basemap and thematic layer:</p>
<ul>
<li>countries polygon layer for basemap</li>
<li>airports point layer for thematic layer</li>
</ul>
<p>I decided that animation should go like this:</p>
<ol>
<li>Load basemap and Vaclav Havel airport (PRG).</li>
<li>Animate destinations one by one. They are revealed in order of their distance from PRG.</li>
<li>Animate airways.</li>
<li>Once airways are animated, animate airplanes along their path from PRG to their destination in order of their time of departure.</li>
<li>Profit.</li>
</ol>
<p>My goal was to create an animation of all departures from Vaclav Havel airport during one day. These data can be obtained at <a href="http://www.flightstats.com/">FlightStats</a>, I didn&#8217;t find a way make this process automatic though. <a href="http://openflights.org/">OpenFlights</a> might be better source then.</p>
<h2>SVG creation</h2>
<p><a href="http://kartograph.org/">Kartograph</a> is a great tool both for SVG generation and scripting. What a pity it&#8217;s probably a dead project according to the last commit date. After installing Python part of library used to create SVG files out of vector geometries, it can be run with something like this:</p>
<pre><code>kartograph --output map.svg --pretty-print --style style.css config.json
</code></pre>
<p>Pretty self-explanatory, let&#8217;s have a look at config file:</p>
<pre><code>{
    "layers": {
        "countries": {
            "src": "ne_50m_admin_0_countries/ne_50m_admin_0_countries.shp",
            "attributes": ["name"]
        },
        "airports": {
            "src": "ne_10m_airports/ne_10m_airports_prg.shp",
            "attributes": ["name", "abbrev"]
        },
        "travels": {
            "src": "ne_10m_airports/travels.shp",
            "attributes": ["time", "distance"]
        },
        "grid": {
            "special": "graticule",
            "latitudes": 10,
            "longitudes": 10
        }
    },
    "proj": {
        "id": "satellite",
        "lon0": 0.0,
        "lat0": 48.0,
        "dist": 45,
        "up": 15
    },
    "bounds": {
        "mode": "bbox",
        "data": [-180, -90, 180, 90],
        "padding": 1
    },
    "export": {
        "round": 1,
        "width": 1000,
        "ratio": 1
    }
}
</code></pre>
<p>It is possible to adjust map settings in many different ways. The most important/interesting:</p>
<ul>
<li>Choose what attributes you want to have exported from source file with <code>attributes</code> key for every layer. They&#8217;ll be available as <code>data-</code> attribute of SVG elements.</li>
<li>It comes with Grid generation packed in! Really great. Sea generation works for some projections only.</li>
<li>Set the projections you want to use with additional settings.</li>
<li><code>bounds</code> settings should - according to the docs - use layer extent as well, I couldn&#8217;t make it work though. Use <code>[-180, -90, 180, 90]</code> as a workaround to get the whole world. Don&#8217;t forget to set <code>padding</code>, so your map doesn&#8217;t get clipped on edges.</li>
<li><code>export</code>ing coordinates rounded to one decimal place makes your SVG a lot smaller.</li>
</ul>
<p>You can change SVG look with simple CSS, just be sure to use layer names as CSS ids:</p>
<pre><code>#airports {
    fill: #CC0000;
    fill-opacity: 0;
    stroke: #660000;
    stroke-opacity: 0;
}

#countries {
    fill: #e6deb4;
    stroke: #a59f81;
}

#grid {
    stroke: #d0d0d0;
    stroke-width: .3px;
}

#travels {
    stroke: #1f78b4;
    stroke-opacity: 0;
    stroke-dasharray: 5,5;
}
</code></pre>
<h2>Data adjustment &amp; animation</h2>
<p><strong>SMIL</strong> is a XML based language for multimedia representation. It comes ready for timing, animation, visual transitions etc. I guess it might be considered easier to read for a web development beginner. Once you start using it, you immediately realize it suffers from the same disease like XML does: it is so wordy!</p>
<p>Let&#8217;s get back to my example. To animate airports one by one, let&#8217;s give them unique ids, so they look something like:</p>
<pre><code>&lt;circle id="brs" stroke-opacity="0" fill-opacity="0" cx="476.597304864" cy="539.487783171" data-abbrev="BRS" data-name="Bristol Int'l" r="3"/&gt;
</code></pre>
<p>That&#8217;s something you do by hand as kartograph doesn&#8217;t give ids to SVG elements. Once you&#8217;re done with that, you can run SMIL animation. If you look closer at the final map, you&#8217;ll notice there are three properties animated for each airport: fill opacity, stroke opacity and radius. Each property needs to use separate SMIL <code>&lt;animate /&gt;</code>, which might look like the one below:</p>
<pre><code>&lt;animate attributeName="fill-opacity"
    id="kos_ani_fo"
    from="0"
    to="1"
    begin="osr_ani.end"
    dur="0.25s"
    fill="freeze"
    xlink:href="#kos"
/&gt;
&lt;animate attributeName="stroke-opacity"
    id="kos_ani_so"
    from="0"
    to="1"
    begin="osr_ani.end"
    dur="0.25s"
    fill="freeze"
    xlink:href="#kos"
/&gt;
&lt;animate attributeName="r"
    id="kos_ani_r"
    from="10px"
    to="3px"
    begin="osr_ani.end"
    dur="0.25s"
    xlink:href="#kos"
/&gt;
</code></pre>
<p>I guess you get the idea how long this would take for more airports. Make sure to notice that SMIL can start animation based on another animation&#8217;s end (<code>osr_ani.end</code>) - that&#8217;s pretty neat.</p>
<p>Airways animation works almost the same. First, add unique id to each airway:</p>
<pre><code>&lt;path d="M550.9,562.9L568.0,495.0 " id="travel-arn"/&gt;
</code></pre>
<p>Second, start animation after all the airports are visible on the map. Notice the initial definition of <code>d</code> attribute - it&#8217;s a line with zero length.</p>
<pre><code>&lt;animate attributeName="d"
    id="path_ani"
    from="M550.9,562.9L550.9,562.9"
    to="M550.9,562.9L568.0,495.0"
    begin="icn_ani_r.end"
    dur="3s"
    xlink:href="#travel-arn"
/&gt;
</code></pre>
<p>Once airways animation has finished, let airplanes fly around the globe with a simple JavaScript function:</p>
<pre><code>/**
 * @param  number coef  scale radius by number of flights to the given destination
 * @param  string flight_id
 */
var circle = function(coef, flight_id, timeshift) {
    var svgns = "http://www.w3.org/2000/svg";
    var svgDocument =document;
    var motion = svgDocument.createElementNS(svgns,"animateMotion");
    var animation = svgDocument.createElementNS(svgns,"animate");
    var shape  = svgDocument.createElementNS(svgns, "circle");
    var time = 15 + timeshift;
    var dur = document.getElementById(flight_id).getAttributeNS(null, "data-dist")/100;
    motion.setAttribute("begin", time + "s");
    motion.setAttribute("dur", dur + "s");
    motion.setAttribute("path", document.getElementById(flight_id).getAttributeNS(null, "d"));
    motion.setAttribute("xlink:href", "#" + flight_id);
    motion.setAttribute("id", flight_id + "_motion");

    animation.setAttribute("attributeName", "opacity");
    animation.setAttribute("from", "1");
    animation.setAttribute("to", "0");
    animation.setAttribute("begin", time + dur + "s");
    animation.setAttribute("dur", "0.1s");
    animation.setAttribute("fill", "freeze");


    shape.setAttributeNS(null, "r",  1*coef);
    shape.setAttributeNS(null, "fill", "1f78b4");
    shape.setAttributeNS(null, "stroke", "1f78b4");
    shape.setAttribute("id", "airplane-" + flight_id);
    shape.appendChild(motion);
    shape.appendChild(animation);

    document.getElementById("airplanes").appendChild(shape);
}
</code></pre>
<p>SMIL with SVG seems to be interesting option for web map animation, a bit lengthy though. Syncing animations can easily become pain in the ass (<a href="https://stackoverflow.com/questions/29897355/svg-smil-animatemotion-only-triggers-once/">see StackOverflow thread</a>). Never call your function <code>animate</code> - there is namesake function defined in <a href="https://w3c.github.io/web-animations/">Web Animations API</a> that makes animation crash in Chrome. <code>&lt;animateMotion /&gt;</code> is a great tool to animate elements along path.</p>
	</section>
</article>		<article>
	<header>
	<h2><a href="/posts/2014/connecting-to-secured-arcgis-server-layer-with-openlayers-3/">Connecting To Secured ArcGIS Server Layer With OpenLayers 3</a></h2>
	<small>Written on Sep 12, 2014
		and marked as
		<a href="/posts/tag/javascript/">javascript</a>, 		<a href="/posts/tag/openlayers/">openlayers</a>, 		<a href="/posts/tag/ogc/">ogc</a>				| <a href="/posts/category/web maps/">web maps</a>
		</small>
	</header>
	<section>
	<p>I was made to use ArcGIS Server with <a href="http://openlayers.org">Openlayers 3</a> just recently as one of the projects I&#8217;ve been working on demands such different tools to work together. </p>
<p><strong>tl;dr: I hate Esri.</strong></p>
<p>I found myself in need to access secured layers published via WMS on ArcGIS Server using username and password I was given, so here&#8217;s a little how-to for anyone who would have to do the same.</p>
<p>Let&#8217;s start with a simple ol.layer.Image and pretend this is the secured layer we&#8217;re looking for:</p>
<pre><code>var layer = new ol.layer.Image({
    extent: extent,
    source: new ol.source.ImageWMS(/** @type {olx.source.ImageWMSOptions} */ ({
        url: url,
        params: {
            'LAYERS': 'layer',
            'CRS': 'EPSG:3857',
        }
    }))
});
</code></pre>
<p>We need to retrieve the token, so we define a function:</p>
<pre><code>function retrieveToken(callback) {
    var req = new XMLHttpRequest;

    req.onload = function() {
        if (req.status == "200") {
            var response = JSON.parse(req.responseText);
            if (response.contents) {
                callback(response.contents); // response contents is where the token is stored
        }
    };
    req.open("get", "http://server.address/arcgis/tokens/?request=getToken&amp;username=username&amp;password=password&amp;expiration=60", true);
    req.send()
}
</code></pre>
<p>I pass a parameter called <code>callback</code> - that&#8217;s a very important step, otherwise you would not be able to retrieve the token when you actually need it (AJAX stands for asynchronous). Now you just pass the token to the layer params like this:</p>
<pre><code>retrieveToken(function(token) {
    layer.getSource().updateParams({
        token: token
    })
}
</code></pre>
<p>When you open Firebug and inspect Network tab, you should find <code>token</code> URL parameter passed along with WMS <code>GetMap</code> request.</p>
<p>Few sidenotes:</p>
<ol>
<li>Although you might be logged in ArcGIS Server via web interface, you might need to pass the <code>token</code>  URL param when trying to access Capabilities document. Don&#8217;t know why though.</li>
<li>You should probably take care of calling the <code>retrieveToken()</code> in shorter interval than the token expiration is set to. Otherwise you might end up with invalid token.</li>
<li>You need to hide the username and password from anonymous users (I guess that&#8217;s only possible with server side implementation of selective JavaScript loading).</li>
</ol>
	</section>
</article>		<article>
	<header>
	<h2><a href="/posts/2014/wmts-few-things-i-want-to-remember/">WMTS: Few Things I Want To Remember</a></h2>
	<small>Written on Sep 10, 2014
		and marked as
		<a href="/posts/tag/ogc/">ogc</a>, 		<a href="/posts/tag/wmts/">wmts</a>				| <a href="/posts/category/web maps/">web maps</a>
		</small>
	</header>
	<section>
	<ul>
<li>Used to serve prepared rectangular tiles; this means you are limited by web server speed rather than map server speed</li>
<li>Several ways to retrieve tiles are defined: KVP and REST are mandatory, SOAP is optional</li>
<li>Does not allow layer combination; additional tile matrix would have to be created</li>
<li>GetCapabilities, GetTile and GetFeatureInfo requests are defined</li>
<li><strong>tile</strong></li>
<li>rectangular representation of space</li>
<li>defined by tile and row indices</li>
<li><strong>tile matrix</strong></li>
<li>set of tiles for a given scale</li>
<li><em>defined with:</em><ul>
<li>tile size derived from standardized pixel size (0.28 &times; 0.28 mm)</li>
<li>tile width and tile height (px)</li>
<li>left upper corner coordinates</li>
<li>matrix width and height as number of tiles</li>
</ul>
</li>
<li><strong>tile matrix set</strong></li>
<li>set of tile matrices for different scales</li>
</ul>
<h3>Total count of tile matrices</h3>
<p><em><code>nTileMatrices × nTiledStyles × nTiledFormats (if no dimensions are defined)</code></em></p>
<h3>Total count of tiles in a tile matrix</h3>
<p><em><code>matrixWidth × matrixHeight</code></em></p>
<h3>Other equations</h3>
<ul>
<li><code>pixelSpan = scaleDenominator × 0.28 10<sup>3</sup> / metersPerUnit(crs);</code></li>
<li><code>tileSpanX = tileWidth × pixelSpan;</code></li>
<li><code>tileSpanY = tileHeight × pixelSpan;</code></li>
<li><code>tileMatrixMaxX = tileMatrixMinX + tileSpanX × matrixWidth;</code></li>
<li><code>tileMatrixMinY = tileMatrixMaxY - tileSpanY × matrixHeight;</code></li>
</ul>
<p><img src="/posts/2014/wmts-few-things-i-want-to-remember/wmts.png" title="WMTS tiling schema" class="img-responsive centered"></p>
	</section>
</article></section>
                                          </div>
                </div>
            </div>
            <div class="row white">
                <footer role="contentinfo">
                                          
                                                              <p>Written by <a href="http://www.zimmi.cz">Michal Zimmermann</a>. Baked with <em><a href="http://bolt80.com/piecrust/">PieCrust</a> 2.0.0a6-11-g296b35a</em>.</p>
                </footer>
            </div>
        </div>
    </div>
    <script>
      (function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
      (i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
      m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
      })(window,document,'script','//www.google-analytics.com/analytics.js','ga');

      ga('create', 'UA-43432739-2', 'auto');
      ga('send', 'pageview');
    </script>
</body>
</html>