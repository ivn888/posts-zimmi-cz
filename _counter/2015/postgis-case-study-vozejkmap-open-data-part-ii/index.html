<!DOCTYPE html>

<head>
  <meta charset="utf-8">
  <meta name="author" content="Michal Zimmermann">
  <meta name="description" content="Pieces of knowledge from the world of GIS." />
  <meta name="HandheldFriendly" content="True">
  <meta name="MobileOptimized" content="320">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <title> Michal Zimmermann  &mdash; Postgis Case Study Vozejkmap Open Data Part II </title>
  <link rel="stylesheet" type="text/css" href="/posts/css/style.min.css" />
  <link href='http://fonts.googleapis.com/css?family=Roboto+Condensed:400,700' rel='stylesheet' type='text/css'>
  <script src="/posts/js/highlight.pack.js" defer></script>
  <script>
    window.onload = function() {
      var pre = document.getElementsByTagName('pre');
      for (var i = 0; i < pre.length; i += 1) {
        hljs.highlightBlock(pre[i].firstChild);
      }
    }
  </script>
</head>
<body>
    <div id="main" class="container">
        <div class="row">
            <header role="banner">
                <hgroup>
                    <h1><a href="/posts/">Michal Zimmermann</a></h1>
                    <strong>Pieces of knowledge from the world of GIS.</strong>
                </hgroup>
            </header>
            <nav role="navigation">
                <ul class="nav nav-pills main-navigation">
                    <li><a href="/posts/">Home</a></li>
                    <li><a href="/posts/categories/">Categories</a></li>
                    <li><a href="/posts/tags/">Tags</a></li>
                    <li><a href="/posts/feed.xml">RSS</a></li>
                </ul>
            </nav>
        </div>
        <div class="shadow">
            <div class="row white">
                <div id="content">
                    <div class="blog-index">
                                                                        <h1>Postgis Case Study Vozejkmap Open Data Part II</h1>
                          <small>Written on February 21, 2015                                                     and marked as
                                                    <a href="/posts/tag/postgresql/">postgresql</a>,                                                     <a href="/posts/tag/postgis/">postgis</a>                                                                                                        | <a href="/posts/category/sql/">SQL</a>
                                                    </small>
                                                  <p><a href="http://posts.zimmi.cz/2014/postgis-case-study-vozejkmap-open-data-part-i/">In the first part of my little case study</a> I downloaded <a href="http://vozejkmap.cz">vozejkmap.cz</a> dataset and imported it into the PostGIS database. Having spatial data safely stored the time comes to get it onto the map. Libraries used are:</p>

<ul>
<li><a href="http://leafletjs.com">Leaflet</a></li>
<li><a href="https://github.com/lvoogdt/Leaflet.awesome-markers">Leaflet.awesome-markers</a></li>
<li><a href="https://github.com/Leaflet/Leaflet.markercluster">Leaflet.markercluster</a></li>
</ul>

<p>I teach cartography visualization classes this semester and this map should serve well as an example of what can be done with online maps.</p>

<h2>Retrieving data from the PostGIS database</h2>

<p>Our goal is to build the whole map as a static HTML page without any backend logic. Thus, data needs to be extracted from the database into the format readable with Leaflet - <a href="http://geojson.org/">GeoJSON</a>.</p>

<p>That&#8217;s fairly easy with the <a href="http://www.postgresonline.com/journal/archives/267-Creating-GeoJSON-Feature-Collections-with-JSON-and-PostGIS-functions.html">postgresonline.com tutorial</a>. It took me quite a time to find out what the following query does. Splitting it into smaller chunks helped a lot.</p>

<pre><code>SELECT row_to_json(fc)
FROM (
SELECT 'FeatureCollection' AS type,
    array_to_json(array_agg(f)) AS features
    FROM (SELECT 'Feature' AS type,
        ST_AsGeoJSON(lg.geom)::json As geometry,
        row_to_json((SELECT l FROM (SELECT id, title, location_type, description, author_name, attr1, attr2, attr3) AS l
  )) AS properties
FROM vozejkmap AS lg ) AS f )  AS fc \g /path/to/file.json;
</code></pre>

<p>To get all rows with <code>type</code>, <code>geometry</code> and <code>properties</code> columns (these are the ones defined in GeoJSON specification, see the link above), run this:</p>

<pre><code>SELECT 'Feature' AS type,
            ST_AsGeoJSON(lg.geom)::json As geometry,
            row_to_json((SELECT l FROM (SELECT id, title, location_type, description, author_name, attr1, attr2, attr3) AS l
      )) AS properties
    FROM vozejkmap AS lg
</code></pre>

<p><code>array_agg()</code> squashes all the rows into an array while <code>array_to_json()</code> returns the array as JSON.</p>

<pre><code>SELECT 'FeatureCollection' AS type,
    array_to_json(array_agg(f)) AS features
    FROM (SELECT 'Feature' AS type,
        ST_AsGeoJSON(lg.geom)::json As geometry,
        row_to_json((SELECT l FROM (SELECT id, title, location_type, description, author_name, attr1, attr2, attr3) AS l
  )) AS properties
FROM vozejkmap AS lg ) AS f
</code></pre>

<p>In the last step (the whole code as shown above) <code>row_to_json</code> returns the result as JSON.</p>

<h3>Caveats</h3>

<p>If you run this code from the psql console, be sure you</p>

<ul>
<li>set <em>show only row</em> to true with <code>\t</code></li>
<li>set <em>expanded output</em> to false with <code>\x off</code></li>
</ul>

<p>If you don&#8217;t, you&#8217;ll have lots of hyphens and column names saved to the json file.</p>

<h2>Leaflet map</h2>

<p>Map JavaScript is rather simple with ~30 lines of code (not taking styles into account). Thanks to the great plugins it is easy to show ~7,600 points on the map real quick.</p>

<p>I didn&#8217;t do much customization apart from styling markers and binding popups.</p>

<p><img src="/posts/2015/postgis-case-study-vozejkmap-open-data-part-ii/map.png" title="vozejkmap.cz data map" class="img-responsive centered"></p>

<h2>What&#8217;s next</h2>

<ol>
<li><a href="http://turfjs.org">Turf</a> which means I need to think of what could be fun to do with this data</li>
<li>Layers switching</li>
<li>Map key (by extending L.Control)</li>
</ol>

<p>The code is still <a href="https://github.com/zimmicz/vozejkmap-to-postgis">available at my GitHub</a>.</p>

                                          </div>
                </div>
            </div>
            <div class="row white">
                <footer role="contentinfo">
                          <a class="pagination" href="/posts/2015/using-postgresql-to-update-outdated-map-links/">&laquo; Using PostgreSQL To Update Outdated Map Links</a>
  
                      <p>Written by <a href="http://www.zimmi.cz">Michal Zimmermann</a>. Baked with <em><a href="http://bolt80.com/piecrust/">PieCrust</a> 1.2.0</em>.</p>
                </footer>
            </div>
        </div>
    </div>
    <script>
      (function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
      (i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
      m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
      })(window,document,'script','//www.google-analytics.com/analytics.js','ga');

      ga('create', 'UA-43432739-2', 'auto');
      ga('send', 'pageview');
    </script>
</body>
</html>