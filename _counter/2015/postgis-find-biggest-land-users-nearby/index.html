<!DOCTYPE html>

<head>
  <meta charset="utf-8">
  <meta name="author" content="Michal Zimmermann">
  <meta name="description" content="Pieces of knowledge from the world of GIS." />
  <meta name="HandheldFriendly" content="True">
  <meta name="MobileOptimized" content="320">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <title> Michal Zimmermann  &mdash; PostGIS: Finding Biggest Land Users Nearby </title>
  <link rel="stylesheet" type="text/css" href="/posts//css/style.min.css" />
  <link href='http://fonts.googleapis.com/css?family=Roboto+Condensed:400,700' rel='stylesheet' type='text/css'>
  <script src="/posts//js/highlight.pack.js" defer></script>
  <script>
    window.onload = function() {
      var pre = document.getElementsByTagName('pre');
      for (var i = 0; i < pre.length; i += 1) {
        hljs.highlightBlock(pre[i].firstChild);
      }
    }
  </script>
</head>
<body>
    <div id="main" class="container">
        <div class="row">
            <header role="banner">
                <hgroup>
                    <h1><a href="/posts/">Michal Zimmermann</a></h1>
                    <strong>Pieces of knowledge from the world of GIS.</strong>
                </hgroup>
            </header>
            <nav role="navigation">
                <ul class="nav nav-pills main-navigation">
                    <li><a href="/posts/">Home</a></li>
                    <li><a href="/posts/categories/">Categories</a></li>
                    <li><a href="/posts/tags/">Tags</a></li>
                    <li><a href="/posts/feed.xml/">RSS</a></li>
                </ul>
            </nav>
        </div>
        <div class="shadow">
            <div class="row white">
                <div id="content">
                    <div class="blog-index">
                                                                        <h1>PostGIS: Finding Biggest Land Users Nearby</h1>
                          <small>Written on Apr 03, 2015                                                     and marked as
                                                    <a href="/posts/tag/postgresql/">postgresql</a>,                                                     <a href="/posts/tag/postgis/">postgis</a>                                                                                                        | <a href="/posts/category/SQL/">SQL</a>
                                                    </small>
                                                  <p>At <a href="http://clevermaps.cz">CleverMaps</a> we heavily rely on the cadastre of real estate, which is probably the biggest data source in my country. Using their excellent knowledge of this data set, my teammates often supply me with all kinds of weird challenges.</p>
<h2>Give me the biggest land users nearby</h2>
<p><em>Find the biggest land users in surrounding cadastral communities for each cadastral community (~ 13K)</em> being the latest task, here&#8217;s the query I tackled it with:</p>
<pre><code>WITH users_ AS (
    SELECT
        cad_code,
        id,
        zipcode,
        city,
        concat_ws(' ',street, concat_ws('/', house_number, street_number)) as street,
        name,
        'Users with more than 10 ha'::text note,
        SUM(acreage) area
        FROM land_blocks -- being a table with info about all the agricultural land blocks
        JOIN users u ON id_uz = id
        GROUP BY cad_code, u.id
        HAVING SUM(acreage) &gt; 10
),
ints AS (
    SELECT
        ku.cad_code as community,
        ku2.cad_code as surrounding,
        ku2.cad_name
    FROM cadastral_community ku
    JOIN cadastral_community ku2
        ON ST_Intersects(ku.geom, ku2.geom)
    WHERE ku.cad_code &lt;&gt; ku2.cad_code
)
SELECT
    DISTINCT ON (surrounding, cad_name, u.zipcode, u.city, u.street, u.name)
    surrounding,
    cad_name,
    u.zipcode,
    u.city,
    u.street,
    u.name,
    u.note,
    u.area
FROM
    users_ u
JOIN ints
    ON cad_code = community;
</code></pre>
<p>Few things to note:</p>
<ul>
<li><code>concat_ws()</code> is a great function for joining values that might be <code>NULL</code>. If such a value is found, it is skipped and the function continues with the next one (if any). Thus, you&#8217;ll never get a string ending with a trailing slash (<code>Street name 55/</code>).</li>
<li>With <code>users_</code> CTE I get a list of owners having more than 10 hectares of land for each cadastral community. This gives me the inverse result of what I want (if I know the biggest owners in the cadastral community, I know these are the ones that should be listed for surrounding c. communities).</li>
<li>This <em>putting-it-all-together</em> step is done with <code>ints</code> CTE that outputs the list of surrounding c. communities for each of them.</li>
<li><code>DISTINCT ON</code> cleans up the list so the same owners don&#8217;t appear more than once for any given c. community.</li>
</ul>
<p>Writing this makes me realize the list should be probably sorted by area so only the occurence with the biggest value is kept for each c. community. Simple <code>ORDER BY</code> should deal with this just fine. Or even more sophisticated, using <code>GROUP BY</code> to output the total acreage in all surrounding c. communities.</p>
                                          </div>
                </div>
            </div>
            <div class="row white">
                <footer role="contentinfo">
                          <a class="pagination" href="/posts/2015/postgis-count-line-self-intersections/">&laquo; PostGIS: Count Line Self-Intersections</a>
  
                      <p>Written by <a href="http://www.zimmi.cz">Michal Zimmermann</a>. Baked with <em><a href="http://bolt80.com/piecrust/">PieCrust</a> 2.0.0a6-6-g0fb1eb8</em>.</p>
                </footer>
            </div>
        </div>
    </div>
    <script>
      (function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
      (i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
      m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
      })(window,document,'script','//www.google-analytics.com/analytics.js','ga');

      ga('create', 'UA-43432739-2', 'auto');
      ga('send', 'pageview');
    </script>
</body>
</html>