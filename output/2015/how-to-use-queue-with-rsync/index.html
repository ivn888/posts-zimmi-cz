<!DOCTYPE html>
<html lang="en">
<head>
          <title>Michal Zimmermann | How to Use Queue with Rsync</title>
        <meta charset="utf-8" />
        <meta name="viewport" content="width=device-width, initial-scale=1.0" />
        <link href="http://www.zimmi.cz/posts/atom.xml" type="application/atom+xml" rel="alternate" title="Michal Zimmermann Full Atom Feed" />
        <link href="http://www.zimmi.cz/posts/feed.xml" type="application/rss+xml" rel="alternate" title="Michal Zimmermann Full RSS Feed" />



    <meta name="tags" contents="linux" />
    <meta name="tags" contents="bash" />

        <link rel="stylesheet" href="http://www.zimmi.cz/posts/theme/css/foundation.min.css" />
        <link rel="stylesheet" href="http://www.zimmi.cz/posts/theme/css/screen.css" />
        <link rel="stylesheet" href="http://www.zimmi.cz/posts/theme/css/pygment.css" />
        <link rel="stylesheet" href="//cdnjs.cloudflare.com/ajax/libs/highlight.js/8.5/styles/railscasts.min.css">
</head>

<body id="index" class="home">
    <div class="fixed">
        <nav class="top-bar">
            <section class="top-bar-section">
                <ul class="left">
                    <li class="divider"></li>
                    <li class="active"><a href="/posts">Home</a></li>
                    <li class="divider"></li>
                    <li><a href="http://www.zimmi.cz/posts/categories">Categories</a></li>
                    <li class="divider"></li>
                    <li><a href="http://www.zimmi.cz/posts/tags">Tags</a></li>
                    <li class="divider"></li>
                    <li><a href="http://www.zimmi.cz/posts/feed.xml">RSS</a></li>
                </ul>
            </section>
        </nav>
    </div>
        <div class="row">
          <div class="large-12 columns header">
            <h1><a href="/posts">Michal Zimmermann</a> <small>Pieces of knowledge from the world of GIS.</small></h1>
          </div>
        </div>
        <div class="row">
            <div class="large-12 columns">
<div class="panel">
    <div class="post-name">
        <h1><a href="http://www.zimmi.cz/posts/2015/how-to-use-queue-with-rsync/" rel="bookmark" title="Permalink to How to Use Queue with Rsync">How to Use Queue with Rsync</a></h1>
        <small>Written on Oct 1, 2015
    and marked as
    <a href="http://www.zimmi.cz/posts/tag/linux.html">linux</a>,     <a href="http://www.zimmi.cz/posts/tag/bash.html">bash</a>    | <a href="http://www.zimmi.cz/posts/category/automation.html">automation</a>
    </small>
    <section>
        <p>Having more than 120K 5MB+ images that should be moved to the server is a great oportunity for some automatic bash processing. It might be good idea to use <a href="http://www.imagemagick.org/script/index.php">ImageMagick</a> <a href="http://www.imagemagick.org/script/convert.php">convert tool</a> to make images smaller in a simple for loop. <a href="http://www.gnu.org/software/parallel/">GNU Parallel</a> can significantly increase the performance by running one job per CPU core.</p>
<div class="highlight"><pre>parallel --verbose convert <span class="o">{}</span> -quality 40% <span class="o">{}</span> ::: *.jpg
</pre></div>


<p>The <code>parallel</code> modifies several images per second. Uploading these right away seems to be a good idea. But how do you tell <code>rsync</code> to check for modified files every now and then? Another for loop mixed with <code>sleep</code> would work, but it just doesn't feel right.</p>
<p>Luckily, there's a <a href="http://linux.die.net/man/1/inotifywait"><code>inotifywait</code></a> tool capable of watching changes to files and taking actions based on those changes.</p>
<div class="highlight"><pre>inotifywait -e close_write -m --format <span class="s1">&#39;%f&#39;</span> . <span class="se">\|</span>
<span class="k">while</span> <span class="nb">read </span>file
<span class="k">do</span>
    <span class="nb">echo</span> <span class="nv">$file</span>
    rsync -OWRD0Pq --ignore-existing <span class="nv">$file</span> data@localhost
<span class="k">done</span>
</pre></div>


<p>By default, <code>inotifywait</code> stops after receiving a single event, while <code>-m</code> flag runs it indefinitely. <code>-e</code> flag defines an event to watch for, in my case that's a <code>close_write</code> event. The <code>inotifywait</code> output can be piped to <code>rsync</code> that takes care of syncing local files to remote server.</p>
<p>The last step, as usual, is profit.</p>
    </section>
    </div>
<div class="neighbors">
    <h3>More reading</h3>
    <ul>
        <li>
            <a href="http://www.zimmi.cz/posts/2015/automated-map-creation-with-qgis-postgis-python-svg-and-imagemagick/">
                 Automated Map Creation With QGIS, PostGIS, Python, SVG and ImageMagick
            </a>
        </li>
         <li>
             <a href="http://www.zimmi.cz/posts/2015/automated-map-creation-with-qgis-postgis-python-svg-and-imagemagick/">
                 Automated Map Creation With QGIS, PostGIS, Python, SVG and ImageMagick
             </a>
         </li>
        </li>
    </ul>
</div></div>
            </div>
        </div>
        <div class="row">
            <div class="large-12 columns footer">
                <footer>
                    <address>
                    Written by <a href="http://www.zimmi.cz">Michal Zimmermann</a>.
                    Proudly powered by <a href="http://getpelican.com/">Pelican</a>,
                    which takes great advantage of <a href="http://python.org">Python</a>.
                    </address><!-- /#about -->
                </footer><!-- /#contentinfo -->
            </div>
        </div>
    <script type="text/javascript">
    var _gaq = _gaq || [];
    _gaq.push(['_setAccount', 'UA-43432739-2']);
    _gaq.push(['_trackPageview']);
    (function() {
        var ga = document.createElement('script'); ga.type = 'text/javascript'; ga.async = true;
        ga.src = ('https:' == document.location.protocol ? 'https://ssl' : 'http://www') + '.google-analytics.com/ga.js';
        var s = document.getElementsByTagName('script')[0]; s.parentNode.insertBefore(ga, s);
    })();
    </script>
</body>
</html>