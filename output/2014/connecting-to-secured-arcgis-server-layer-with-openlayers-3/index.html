<!DOCTYPE html>
<html lang="en">
<head>
          <title>Michal Zimmermann | Pieces of knowledge from the world of GIS.</title>
        <meta charset="utf-8" />
        <meta name="viewport" content="width=device-width, initial-scale=1.0" />
        <link href="http://www.zimmi.cz/posts/atom.xml" type="application/atom+xml" rel="alternate" title="Michal Zimmermann Full Atom Feed" />
        <link href="http://www.zimmi.cz/posts/feed.xml" type="application/rss+xml" rel="alternate" title="Michal Zimmermann Full RSS Feed" />



    <meta name="tags" contents="javascript" />
    <meta name="tags" contents="openlayers" />
    <meta name="tags" contents="ogc" />

        <link rel="stylesheet" href="http://www.zimmi.cz/posts/theme/css/foundation.min.css" />
        <link rel="stylesheet" href="http://www.zimmi.cz/posts/theme/css/screen.css" />
        <link rel="stylesheet" href="http://www.zimmi.cz/posts/theme/css/pygment.css" />
        <link rel="stylesheet" href="//cdnjs.cloudflare.com/ajax/libs/highlight.js/8.5/styles/railscasts.min.css">
</head>

<body id="index" class="home">
    <div class="fixed">
        <nav class="top-bar">
            <section class="top-bar-section">
                <ul class="left">
                    <li class="divider"></li>
                    <li class="active"><a href="/">Home</a></li>
                    <li class="divider"></li>
                    <li><a href="http://www.zimmi.cz/posts/categories">Categories</a></li>
                    <li class="divider"></li>
                    <li><a href="http://www.zimmi.cz/posts/tags">Tags</a></li>
                    <li class="divider"></li>
                    <li><a href="http://www.zimmi.cz/posts/feed.xml">RSS</a></li>
                </ul>
            </section>
        </nav>
    </div>
        <div class="row">
          <div class="large-12 columns header">
            <h1><a href="/">Michal Zimmermann</a> <small>Pieces of knowledge from the world of GIS.</small></h1>
          </div>
        </div>
        <div class="row">
            <div class="large-12 columns">
<div class="panel">
    <div class="post-name">
        <h2><a href="http://www.zimmi.cz/posts/2014/connecting-to-secured-arcgis-server-layer-with-openlayers-3/" rel="bookmark" title="Permalink to Connecting To Secured ArcGIS Server Layer With OpenLayers 3">Connecting To Secured ArcGIS Server Layer With OpenLayers 3</a></h2>
        <small>Written on Sep 12, 2014
    and marked as
    <a href="http://www.zimmi.cz/posts/tag/javascript.html">javascript</a>,     <a href="http://www.zimmi.cz/posts/tag/openlayers.html">openlayers</a>,     <a href="http://www.zimmi.cz/posts/tag/ogc.html">ogc</a>    | <a href="http://www.zimmi.cz/posts/category/web-maps.html">web maps</a>
    </small>
    <section>
        <p>I was made to use ArcGIS Server with <a href="http://openlayers.org">Openlayers 3</a> just recently as one of the projects I've been working on demands such different tools to work together.</p>
<p><strong>tl;dr: I hate Esri.</strong></p>
<p>I found myself in need to access secured layers published via WMS on ArcGIS Server using username and password I was given, so here's a little how-to for anyone who would have to do the same.</p>
<p>Let's start with a simple ol.layer.Image and pretend this is the secured layer we're looking for:</p>
<div class="highlight"><pre>var layer = new ol.layer.Image({
    extent: extent,
    source: new ol.source.ImageWMS(/** @type {olx.source.ImageWMSOptions} */ ({
        url: url,
        params: {
            &#39;LAYERS&#39;: &#39;layer&#39;,
            &#39;CRS&#39;: &#39;EPSG:3857&#39;,
        }
    }))
});
</pre></div>


<p>We need to retrieve the token, so we define a function:</p>
<div class="highlight"><pre><span class="kd">function</span> <span class="nx">retrieveToken</span><span class="p">(</span><span class="nx">callback</span><span class="p">)</span> <span class="p">{</span>
    <span class="kd">var</span> <span class="nx">req</span> <span class="o">=</span> <span class="k">new</span> <span class="nx">XMLHttpRequest</span><span class="p">;</span>

    <span class="nx">req</span><span class="p">.</span><span class="nx">onload</span> <span class="o">=</span> <span class="kd">function</span><span class="p">()</span> <span class="p">{</span>
        <span class="k">if</span> <span class="p">(</span><span class="nx">req</span><span class="p">.</span><span class="nx">status</span> <span class="o">==</span> <span class="s2">&quot;200&quot;</span><span class="p">)</span> <span class="p">{</span>
            <span class="kd">var</span> <span class="nx">response</span> <span class="o">=</span> <span class="nx">JSON</span><span class="p">.</span><span class="nx">parse</span><span class="p">(</span><span class="nx">req</span><span class="p">.</span><span class="nx">responseText</span><span class="p">);</span>
            <span class="k">if</span> <span class="p">(</span><span class="nx">response</span><span class="p">.</span><span class="nx">contents</span><span class="p">)</span> <span class="p">{</span>
                <span class="nx">callback</span><span class="p">(</span><span class="nx">response</span><span class="p">.</span><span class="nx">contents</span><span class="p">);</span> <span class="c1">// response contents is where the token is stored</span>
        <span class="p">}</span>
    <span class="p">};</span>
    <span class="nx">req</span><span class="p">.</span><span class="nx">open</span><span class="p">(</span><span class="s2">&quot;get&quot;</span><span class="p">,</span> <span class="s2">&quot;http://server.address/arcgis/tokens/?request=getToken&amp;username=username&amp;password=password&amp;expiration=60&quot;</span><span class="p">,</span> <span class="kc">true</span><span class="p">);</span>
    <span class="nx">req</span><span class="p">.</span><span class="nx">send</span><span class="p">()</span>
<span class="p">}</span>
</pre></div>


<p>I pass a parameter called <code>callback</code> - that's a very important step, otherwise you would not be able to retrieve the token when you actually need it (AJAX stands for asynchronous). Now you just pass the token to the layer params like this:</p>
<div class="highlight"><pre><span class="nx">retrieveToken</span><span class="p">(</span><span class="kd">function</span><span class="p">(</span><span class="nx">token</span><span class="p">)</span> <span class="p">{</span>
    <span class="nx">layer</span><span class="p">.</span><span class="nx">getSource</span><span class="p">().</span><span class="nx">updateParams</span><span class="p">({</span>
        <span class="nx">token</span><span class="o">:</span> <span class="nx">token</span>
    <span class="p">})</span>
<span class="p">}</span>
</pre></div>


<p>When you open Firebug and inspect Network tab, you should find <code>token</code> URL parameter passed along with WMS <code>GetMap</code> request.</p>
<p>Few sidenotes:</p>
<ol>
<li>Although you might be logged in ArcGIS Server via web interface, you might need to pass the <code>token</code>  URL param when trying to access Capabilities document. Don't know why though.</li>
<li>You should probably take care of calling the <code>retrieveToken()</code> in shorter interval than the token expiration is set to. Otherwise you might end up with invalid token.</li>
<li>You need to hide the username and password from anonymous users (I guess that's only possible with server side implementation of selective JavaScript loading).</li>
</ol>
    </section>
    </div>
<div class="neighbors">
    <h3>More reading</h3>
    <ul>
        <li>
            <a href="http://www.zimmi.cz/posts/2014/blogging-on-docker-piecrust-to-the-rescue/">
                 Blogging On Docker: Piecrust To The Rescue
            </a>
        </li>
         <li>
             <a href="http://www.zimmi.cz/posts/2014/switch-latitude-and-longitude-with-regular-expression/">
                 Switch Latitude And Longitude With Regular Expression
             </a>
         </li>
         <li>
             <a href="http://www.zimmi.cz/posts/2014/wmts-few-things-i-want-to-remember/">
                 WMTS: Few Things I Want To Remember
             </a>
         </li>
         <li>
             <a href="http://www.zimmi.cz/posts/2015/animating-svg-maps-with-smil/">
                 Animating SVG Maps With SMIL
             </a>
         </li>
        </li>
    </ul>
</div></div>
            </div>
        </div>
        <div class="row">
            <div class="large-12 columns footer">
                <footer>
                    <address>
                    Written by <a href="http://www.zimmi.cz">Michal Zimmermann</a>.
                    Proudly powered by <a href="http://getpelican.com/">Pelican</a>,
                    which takes great advantage of <a href="http://python.org">Python</a>.
                    </address><!-- /#about -->
                </footer><!-- /#contentinfo -->
            </div>
        </div>
    <script type="text/javascript">
    var _gaq = _gaq || [];
    _gaq.push(['_setAccount', 'UA-43432739-2']);
    _gaq.push(['_trackPageview']);
    (function() {
        var ga = document.createElement('script'); ga.type = 'text/javascript'; ga.async = true;
        ga.src = ('https:' == document.location.protocol ? 'https://ssl' : 'http://www') + '.google-analytics.com/ga.js';
        var s = document.getElementsByTagName('script')[0]; s.parentNode.insertBefore(ga, s);
    })();
    </script>
</body>
</html>