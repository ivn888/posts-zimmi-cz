<!DOCTYPE html>
<html lang="en">
<head>
        <title>Michal Zimmermann | category: automation</title>
        <meta charset="utf-8" />
        <meta name="viewport" content="width=device-width, initial-scale=1.0" />
        <link href="http://www.zimmi.cz/posts/atom.xml" type="application/atom+xml" rel="alternate" title="Michal Zimmermann Full Atom Feed" />
        <link href="http://www.zimmi.cz/posts/feed.xml" type="application/rss+xml" rel="alternate" title="Michal Zimmermann Full RSS Feed" />
        <link rel="stylesheet" href="http://www.zimmi.cz/posts/theme/css/foundation.min.css" />
        <link rel="stylesheet" href="http://www.zimmi.cz/posts/theme/css/screen.css" />
        <link rel="stylesheet" href="http://www.zimmi.cz/posts/theme/css/pygment.css" />
        <link rel="stylesheet" href="//cdnjs.cloudflare.com/ajax/libs/highlight.js/8.5/styles/railscasts.min.css">
</head>

<body id="index" class="home">
    <div class="fixed">
        <nav class="top-bar">
            <section class="top-bar-section">
                <ul class="left">
                    <li class="divider"></li>
                    <li class="active"><a href="/posts">Home</a></li>
                    <li class="divider"></li>
                    <li><a href="http://www.zimmi.cz/posts/categories">Categories</a></li>
                    <li class="divider"></li>
                    <li><a href="http://www.zimmi.cz/posts/tags">Tags</a></li>
                    <li class="divider"></li>
                    <li><a href="http://www.zimmi.cz/posts/feed.xml">RSS</a></li>
                </ul>
            </section>
        </nav>
    </div>
        <div class="row">
          <div class="large-12 columns header">
            <h1><a href="/posts">Michal Zimmermann</a> <small>Pieces of knowledge from the world of GIS.</small></h1>
          </div>
        </div>
        <div class="row">
            <div class="large-12 columns">
<h2 class="text-center">Articles in the automation category</h2>

    <div class="panel">
        <div class="post-name">
            <h2><a href="http://www.zimmi.cz/posts/2015/clip-raster-with-vector-using-gdal/" rel="bookmark" title="Permalink to Clip Raster With Vector Using GDAL">Clip Raster With Vector Using GDAL</a></h2>
            <small>Written on Jul 21, 2015
        and marked as
        <a href="http://www.zimmi.cz/posts/tag/linux.html">linux</a>,         <a href="http://www.zimmi.cz/posts/tag/gdal.html">gdal</a>        | <a href="http://www.zimmi.cz/posts/category/automation.html">automation</a>
        </small>
        <section>
            <p>Recently I needed to clip several raster files with polygonal layer of municipalities. A solution to this task is pretty straightforward using <a href="http://gdal.org/">GDAL</a> and a bit of Bash and QGIS thrown in.</p>
<p>The necessary steps are:</p>
<ol>
<li>Put each polygon to a separate file. This can be done easily with <code>Vector - Data Management Tools - Split Vector Layer</code> in QGIS. The solution below assumes that each shapefile has the same basename as the raster file.</li>
<li>These polygons are stored in the <code>obce</code> subfolder relative to the folder with rasters.</li>
<li>An <code>output</code> folder exists that is used for... output, yes.</li>
<li>Rasters are saved with output alpha band for nodata (<code>-dstalpha</code> flag).</li>
<li>The script takes one argument - raster name.</li>
<li>Profit!</li>
</ol>
<div class="highlight"><pre><span class="c">#!/usr/bin/env bash</span>

<span class="nv">OBEC</span><span class="o">=</span><span class="nv">$1</span>
<span class="nv">BASE</span><span class="o">=</span><span class="k">$(</span>basename <span class="nv">$OBEC</span> _jpeg.tif<span class="k">)</span>
<span class="nb">echo</span> <span class="nv">$BASE</span>
<span class="nv">EXTENT</span><span class="o">=</span><span class="k">$(</span>ogrinfo -so obce/<span class="si">${</span><span class="nv">BASE</span><span class="si">}</span>.shp <span class="nv">$BASE</span> <span class="p">|</span> grep Extent <span class="se">\</span>
<span class="p">|</span> sed <span class="s1">&#39;s/Extent: //g&#39;</span> <span class="p">|</span> sed <span class="s1">&#39;s/(//g&#39;</span> <span class="p">|</span> sed <span class="s1">&#39;s/)//g&#39;</span> <span class="se">\</span>
<span class="p">|</span> sed <span class="s1">&#39;s/ - /, /g&#39;</span><span class="k">)</span>
<span class="nv">EXTENT</span><span class="o">=</span><span class="k">$(</span><span class="nb">echo</span> <span class="nv">$EXTENT</span> <span class="p">|</span> awk -F <span class="s1">&#39;,&#39;</span> <span class="s1">&#39;{print $1 &quot; &quot; $4 &quot; &quot; $3 &quot; &quot; $2}&#39;</span><span class="k">)</span>
gdal_translate -projwin <span class="nv">$EXTENT</span> -of GTiff <span class="nv">$OBEC</span> output/<span class="si">${</span><span class="nv">BASE</span><span class="si">}</span>.tif
gdalwarp -dstalpha -s_srs <span class="s1">&#39;EPSG:5514&#39;</span> -t_srs <span class="s1">&#39;EPSG:5514&#39;</span> <span class="se">\</span>
    -co <span class="nv">COMPRESS</span><span class="o">=</span>JPEG <span class="se">\</span>
    -co <span class="nv">TILED</span><span class="o">=</span>YES -<span class="se">\</span>
    of GTiff <span class="se">\</span>
    -cutline obce/<span class="si">${</span><span class="nv">BASE</span><span class="si">}</span>.shp <span class="se">\</span>
    output/<span class="si">${</span><span class="nv">BASE</span><span class="si">}</span>.tif output/<span class="si">${</span><span class="nv">BASE</span><span class="si">}</span>.final.tif
</pre></div>


<p>Note that if <code>gdalwarp</code> doesn't recognize an EPSG code (which is the case for my country national grid), you might pass it as a PROJ.4 string.</p>
<p>According to the point 5 in the above list, the script needs to be run in a loop:</p>
<div class="highlight"><pre><span class="k">for</span> f in *_jpeg.tif<span class="p">;</span>
    <span class="k">do</span> the_script_above.sh <span class="nv">$f</span>
<span class="p">;</span><span class="k">done</span>
</pre></div>
        </section>
        </div>
    </div>

    <div class="panel">
        <div class="post-name">
            <h2><a href="http://www.zimmi.cz/posts/2015/grass-big-buffers-made-easy/" rel="bookmark" title="Permalink to GRASS: Big Buffers Made Easy">GRASS: Big Buffers Made Easy</a></h2>
            <small>Written on Apr 20, 2015
        and marked as
        <a href="http://www.zimmi.cz/posts/tag/grass.html">grass</a>        | <a href="http://www.zimmi.cz/posts/category/automation.html">automation</a>
        </small>
        <section>
            <p>Recently I've written about <a href="/2015/postgis-buffers-intersections-differences-and-collections/">struggling with fairly complex geometries in PostGIS</a>. Lesson learned from the last time was to use more smaller geometries instead of several really huge. You can obtain the small ones from the big by <a href="/2015/postgis-rectangular-grid-creation/">cutting it with a grid</a>.</p>
<p>A supervisor of a project I've been working on came up with a task that totally buried the previous process in a blink of an eye: <strong>Give me the buffer (diffed with original geometries) that is smoothed on the outer bounds so there are no edges shorter than 10 cm.</strong> I sighed. Then, I cursed. Then, I gave it a try with PostGIS. Achieving this goal involves these steps:</p>
<ul>
<li>Dissolve intersecting buffers</li>
<li>Run some kind of generalization algorithm that is not defined in PostGIS</li>
<li>Diff original geometries</li>
<li>Cut buffer with grid so it works <del>faster</del> not so slow for the next steps</li>
</ul>
<p>Two of those four are rather problematic with PostGIS: line smoothing and diffing the original geometries (I didn't get to the last one, so it might be 3 of 4 as well).</p>
<h2>Hello, I'm GRASS</h2>
<p>I haven't used GRASS for ages and even back then I didn't get to know it much, but it saved the day for me this time.</p>
<div class="highlight"><pre><span class="x">grass -text path/to/mapset -c</span>

<span class="x">v.in.ogr input=&quot;PG:host=localhost dbname=db user=postgres password=postgres&quot; output=ilot_050 layer=ilot_2015_050 snap=-1 --overwrite</span>
<span class="err">#</span><span class="x"> turn the snapping off, I don&#39;t want the input changed in any way, even though it is not topologically valid</span>
<span class="x">v.in.ogr input=&quot;PG:host=localhost dbname=db user=postgres password=postgres&quot; output=lollipops_050 layer=lollipops.lollipops_2015_050_tmp snap=-1 --overwrite</span>
<span class="x">v.in.ogr input=&quot;PG:host=localhost dbname=db user=postgres password=postgres&quot; output=holes_050 layer=phase_3.holes_050 snap=-1 --overwrite</span>
<span class="x">v.db.addcolumn map=ilot_050 columns=&quot;id_0 int&quot;</span>
<span class="x">v.db.update map=ilot_050 column=id_0 value=1</span>

<span class="err">#</span><span class="x"> dissolve didn&#39;t work without a column specified, dunno why</span>
<span class="x">v.dissolve input=ilot_050 column=id_0 output=ilot_050_dissolve --overwrite</span>
<span class="x">v.buffer input=ilot_050_dissolve output=ilot_050_buffer distance=20 --overwrite</span>

<span class="err">#</span><span class="x"> v.out and v.in routine used just because I didn&#39;t get the way attributes work in GRASS, would do it differently next time</span>
<span class="x">v.out.ogr input=ilot_050_buffer output=ilot_050_buffer format=ESRI_Shapefile --overwrite</span>
<span class="x">v.in.ogr input=ilot_050_buffer output=ilot_050_buffer snap=-1 --overwrite</span>
<span class="x">v.overlay ainput=ilot_050_buffer binput=holes_050 operator=or output=combined_050_01 snap=-1 --overwrite</span>

<span class="err">#</span><span class="x"> tried v.patch to combine the three layers, it gave some strange results in the final overlay</span>
<span class="x">v.overlay ainput=combined_050_01 binput=lollipops_050 operator=or output=combined_050_02 snap=-1 --overwrite</span>
<span class="x">v.out.ogr input=combined_050_02 output=combined_050 format=ESRI_Shapefile --overwrite</span>
<span class="x">v.in.ogr input=combined_050 output=combined_050_in snap=-1 --overwrite</span>
<span class="x">v.db.addcolumn map=combined_050_in columns=&quot;id_1 int&quot;</span>
<span class="x">v.db.update map=combined_050_in column=id_1 value=1</span>
<span class="x">v.dissolve input=combined_050_in column=id_1 output=combined_050_dissolve --overwrite</span>

<span class="err">#</span><span class="x"> get rid of &lt; 10cm edges</span>
<span class="x">v.generalize input=combined_050_dissolve output=combined_050_gen method=reduction threshold=0.1 --overwrite</span>
<span class="x">v.out.ogr input=combined_050_gen output=combined_050_gen format=ESRI_Shapefile --overwrite</span>
<span class="x">v.in.ogr input=combined_050_gen output=combined_050_gen snap=-1 --overwrite</span>
<span class="x">v.overlay ainput=combined_050_gen binput=ilot_050 operator=not snap=1e-05 --overwrite output=ilot_050_diff</span>
<span class="x">v.out.postgis input=ilot_050_diff output=&quot;PG:dbname=db user=postgres password=postgres&quot; output_layer=onf3.buffer_050_diff options=&quot;GEOMETRY_NAME=wkb_geometry,SRID=2154&quot; --overwrite</span>
<span class="x">v.in.ogr input=&quot;PG:host=localhost dbname=ign user=postgres password=postgres&quot; output=buffer_050 layer=onf3.buffer_050_diff snap=-1 --overwrite</span>
<span class="x">v.in.ogr input=&quot;PG:host=localhost dbname=ign user=postgres password=postgres&quot; output=grid layer=grid snap=-1 --overwrite</span>
<span class="x">v.db.connect -d map=buffer_050</span>

<span class="err">#</span><span class="x"> instead of v.out and v.in routine</span>
<span class="x">db.connect driver=sqlite database=&#39;</span><span class="p">$</span><span class="nv">GISDBASE</span><span class="x">/</span><span class="p">$</span><span class="nv">LOCATION_NAME</span><span class="x">/</span><span class="p">$</span><span class="nv">MAPSET</span><span class="x">/sqlite.db&#39;</span>
<span class="x">v.db.addtable map=buffer_050</span>
<span class="x">v.overlay ainput=buffer_050 binput=grid operator=and output=buffer_050_grid snap=-1 --overwrite</span>
<span class="x">v.out.postgis input=buffer_050_grid output=&quot;PG:dbname=ign user=postgres password=postgres&quot; output_layer=onf3.buffer_050_diff_grid options=&quot;GEOMETRY_NAME=wkb_geometry,SRID=2154&quot; --overwrite</span>
</pre></div>


<p><strong>It is damn fast</strong> compared to PostGIS. It can be automated. It can be parametrized. It is robust. It is great!</p>
<h2>Lesson learned</h2>
<ul>
<li>You cannot smooth lines by deleting edges shorter than <code>n</code> in PostGIS. At least I haven't found the way to do so without defining your own procedure. You can with GRASS.</li>
<li>GRASS reduction algorithm always keep first and last node untouched. Thus, if they're closer than <code>n</code>, they'll stay even if you'd like to have them deleted.</li>
<li>Getting to grips with GRASS attribute data is rather hard after using shapefiles all your GIS life.</li>
<li>It is great to exploit synergy of different GIS tools used for what they're best at.</li>
</ul>
<p>The more I work with big data, the more I get used to not seeing them. That's kind of a twist after crafting maps at university.</p>
        </section>
        </div>
    </div>

    <div class="panel">
        <div class="post-name">
            <h2><a href="http://www.zimmi.cz/posts/2015/wms-download-for-future-offline-use/" rel="bookmark" title="Permalink to WMS Download For Future Offline Use">WMS Download For Future Offline Use</a></h2>
            <small>Written on Mar 15, 2015
        and marked as
        <a href="http://www.zimmi.cz/posts/tag/ogc.html">ogc</a>,         <a href="http://www.zimmi.cz/posts/tag/python.html">python</a>,         <a href="http://www.zimmi.cz/posts/tag/wms.html">wms</a>        | <a href="http://www.zimmi.cz/posts/category/automation.html">automation</a>
        </small>
        <section>
            <p>Using WMS in real time might easily become pain in the ass due to low connection speed or slow server response. Downloading images beforehand seems to be a reasonable choice both to avoid any slowdowns and to improve user experience when working with WMS layers.</p>
<p><a href="https://geopython.github.io/OWSLib/">OWSLib</a> is a great tool to help you get images from WMS server. Code and some comments follow.</p>
<div class="highlight"><pre><span class="kn">import</span> <span class="nn">math</span>
<span class="kn">import</span> <span class="nn">os</span>
<span class="kn">import</span> <span class="nn">random</span>
<span class="kn">import</span> <span class="nn">time</span>
<span class="kn">from</span> <span class="nn">owslib.wms</span> <span class="kn">import</span> <span class="n">WebMapService</span>

<span class="n">BOTTOM_LEFT</span> <span class="o">=</span> <span class="p">(</span><span class="o">-</span><span class="mi">679363</span><span class="p">,</span><span class="o">-</span><span class="mi">1120688</span><span class="p">)</span>
<span class="n">TOP_RIGHT</span>   <span class="o">=</span> <span class="p">(</span><span class="o">-</span><span class="mi">565171</span><span class="p">,</span><span class="o">-</span><span class="mi">1042703</span><span class="p">)</span>
<span class="n">SRS_WIDTH</span>   <span class="o">=</span> <span class="n">math</span><span class="o">.</span><span class="n">fabs</span><span class="p">(</span><span class="o">-</span><span class="mi">639084</span> <span class="o">-</span> <span class="o">-</span><span class="mi">638825</span><span class="p">)</span> <span class="c"># tile width in units of crs =&gt; 259 m</span>
<span class="n">SRS_HEIGHT</span>  <span class="o">=</span> <span class="n">math</span><span class="o">.</span><span class="n">fabs</span><span class="p">(</span><span class="o">-</span><span class="mi">1070426</span> <span class="o">-</span> <span class="o">-</span><span class="mi">1070273</span><span class="p">)</span> <span class="c"># tile height in units of crs =&gt; 153 m</span>
<span class="n">PX_WIDTH</span>    <span class="o">=</span> <span class="mi">977</span>
<span class="n">PX_HEIGHT</span>   <span class="o">=</span> <span class="mi">578</span>

<span class="n">FORMAT</span>      <span class="o">=</span> <span class="s">&#39;image/png&#39;</span>
<span class="n">LAYERS</span>      <span class="o">=</span> <span class="p">[</span><span class="s">&#39;KN&#39;</span><span class="p">,</span> <span class="s">&#39;RST_PK&#39;</span><span class="p">]</span>
<span class="n">SIZE</span>        <span class="o">=</span> <span class="p">(</span><span class="n">PX_WIDTH</span><span class="p">,</span> <span class="n">PX_HEIGHT</span><span class="p">)</span>
<span class="n">SRS</span>         <span class="o">=</span> <span class="s">&#39;EPSG:5514&#39;</span>
<span class="n">STYLES</span>      <span class="o">=</span> <span class="p">[</span><span class="s">&#39;default&#39;</span><span class="p">,</span> <span class="s">&#39;default&#39;</span><span class="p">]</span>
<span class="n">TRANSPARENT</span> <span class="o">=</span> <span class="bp">True</span>

<span class="n">DIRECTORY</span> <span class="o">=</span> <span class="s">&#39;tiles/&#39;</span>
<span class="n">SLEEP</span>     <span class="o">=</span> <span class="n">random</span><span class="o">.</span><span class="n">randint</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="mi">20</span><span class="p">)</span> <span class="c"># seconds</span>

<span class="n">dx</span> <span class="o">=</span> <span class="n">math</span><span class="o">.</span><span class="n">fabs</span><span class="p">(</span><span class="n">BOTTOM_LEFT</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">-</span> <span class="n">TOP_RIGHT</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span> <span class="c"># area width in units of crs</span>
<span class="n">dy</span> <span class="o">=</span> <span class="n">math</span><span class="o">.</span><span class="n">fabs</span><span class="p">(</span><span class="n">BOTTOM_LEFT</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">-</span> <span class="n">TOP_RIGHT</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span> <span class="c"># area height in units of crs</span>

<span class="n">cols</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">math</span><span class="o">.</span><span class="n">ceil</span><span class="p">(</span><span class="n">dx</span> <span class="o">/</span> <span class="n">SRS_WIDTH</span><span class="p">))</span> <span class="o">+</span> <span class="mi">1</span>
<span class="n">rows</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">math</span><span class="o">.</span><span class="n">ceil</span><span class="p">(</span><span class="n">dy</span> <span class="o">/</span> <span class="n">SRS_HEIGHT</span><span class="p">))</span> <span class="o">+</span> <span class="mi">1</span>

<span class="n">counter</span> <span class="o">=</span> <span class="mi">0</span>

<span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="s">&#39;world_file.pngw&#39;</span><span class="p">,</span> <span class="s">&#39;r&#39;</span><span class="p">)</span> <span class="k">as</span> <span class="n">wld_template</span><span class="p">:</span>
    <span class="n">tmpl</span> <span class="o">=</span> <span class="n">wld_template</span><span class="o">.</span><span class="n">read</span><span class="p">()</span>

<span class="n">wms</span> <span class="o">=</span> <span class="n">WebMapService</span><span class="p">(</span><span class="s">&#39;http://services.cuzk.cz/wms/wms.asp&#39;</span><span class="p">,</span> <span class="n">version</span><span class="o">=</span><span class="s">&#39;1.1.1&#39;</span><span class="p">)</span>

<span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">xrange</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">rows</span><span class="p">):</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">exists</span><span class="p">(</span><span class="n">DIRECTORY</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="n">i</span><span class="p">)):</span>
        <span class="n">os</span><span class="o">.</span><span class="n">mkdir</span><span class="p">(</span><span class="n">DIRECTORY</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="n">i</span><span class="p">))</span>

    <span class="k">for</span> <span class="n">j</span> <span class="ow">in</span> <span class="nb">xrange</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">cols</span><span class="p">):</span>
        <span class="k">if</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">exists</span><span class="p">(</span><span class="n">DIRECTORY</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="n">i</span><span class="p">)</span> <span class="o">+</span><span class="s">&#39;/kn_&#39;</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="n">i</span><span class="p">)</span> <span class="o">+</span> <span class="s">&#39;_&#39;</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="n">j</span><span class="p">)</span> <span class="o">+</span> <span class="s">&#39;.png&#39;</span><span class="p">):</span>
            <span class="n">counter</span> <span class="o">+=</span> <span class="mi">1</span>
            <span class="k">continue</span>

        <span class="n">bbox</span> <span class="o">=</span> <span class="p">(</span>
            <span class="n">i</span> <span class="o">*</span> <span class="n">SRS_WIDTH</span> <span class="o">+</span> <span class="n">BOTTOM_LEFT</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span>
            <span class="n">j</span> <span class="o">*</span> <span class="n">SRS_HEIGHT</span> <span class="o">+</span> <span class="n">BOTTOM_LEFT</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span>
            <span class="p">(</span><span class="n">i</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)</span> <span class="o">*</span> <span class="n">SRS_WIDTH</span> <span class="o">+</span> <span class="n">BOTTOM_LEFT</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span>
            <span class="p">(</span><span class="n">j</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)</span> <span class="o">*</span> <span class="n">SRS_HEIGHT</span> <span class="o">+</span> <span class="n">BOTTOM_LEFT</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span>
        <span class="p">)</span>

        <span class="n">img</span> <span class="o">=</span> <span class="n">wms</span><span class="o">.</span><span class="n">getmap</span><span class="p">(</span>
            <span class="n">layers</span><span class="o">=</span><span class="n">LAYERS</span><span class="p">,</span>
            <span class="n">styles</span><span class="o">=</span><span class="n">STYLES</span><span class="p">,</span>
            <span class="n">srs</span><span class="o">=</span><span class="n">SRS</span><span class="p">,</span>
            <span class="n">bbox</span><span class="o">=</span><span class="n">bbox</span><span class="p">,</span>
            <span class="n">size</span><span class="o">=</span><span class="n">SIZE</span><span class="p">,</span>
            <span class="n">format</span><span class="o">=</span><span class="n">FORMAT</span><span class="p">,</span>
            <span class="n">transparent</span><span class="o">=</span><span class="n">TRANSPARENT</span>
        <span class="p">)</span>

        <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="n">DIRECTORY</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="n">i</span><span class="p">)</span> <span class="o">+</span><span class="s">&#39;/kn_&#39;</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="n">i</span><span class="p">)</span> <span class="o">+</span> <span class="s">&#39;_&#39;</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="n">j</span><span class="p">)</span> <span class="o">+</span> <span class="s">&#39;.png&#39;</span><span class="p">,</span> <span class="s">&#39;wb&#39;</span><span class="p">)</span> <span class="k">as</span> <span class="n">png</span><span class="p">:</span>
            <span class="n">png</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="n">img</span><span class="o">.</span><span class="n">read</span><span class="p">())</span>

        <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="n">DIRECTORY</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="n">i</span><span class="p">)</span> <span class="o">+</span> <span class="s">&#39;/kn_&#39;</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="n">i</span><span class="p">)</span> <span class="o">+</span> <span class="s">&#39;_&#39;</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="n">j</span><span class="p">)</span> <span class="o">+</span> <span class="s">&#39;.pngw&#39;</span><span class="p">,</span> <span class="s">&#39;w&#39;</span><span class="p">)</span> <span class="k">as</span> <span class="n">wld_file</span><span class="p">:</span>
            <span class="n">wld_file</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="n">tmpl</span><span class="p">)</span>
            <span class="n">wld_file</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s">&#39;</span><span class="se">\n</span><span class="s">&#39;</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="n">i</span> <span class="o">*</span> <span class="n">SRS_WIDTH</span> <span class="o">+</span> <span class="n">BOTTOM_LEFT</span><span class="p">[</span><span class="mi">0</span><span class="p">]))</span>
            <span class="n">wld_file</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s">&#39;</span><span class="se">\n</span><span class="s">&#39;</span> <span class="o">+</span> <span class="nb">str</span><span class="p">((</span><span class="n">j</span><span class="o">+</span><span class="mi">1</span><span class="p">)</span> <span class="o">*</span> <span class="n">SRS_HEIGHT</span> <span class="o">+</span> <span class="n">BOTTOM_LEFT</span><span class="p">[</span><span class="mi">1</span><span class="p">]))</span>

        <span class="n">counter</span> <span class="o">+=</span> <span class="mi">1</span>
        <span class="k">print</span> <span class="nb">str</span><span class="p">(</span><span class="n">counter</span><span class="p">),</span> <span class="s">&#39; out of &#39;</span><span class="p">,</span> <span class="nb">str</span><span class="p">(</span><span class="n">rows</span> <span class="o">*</span> <span class="n">cols</span><span class="p">)</span>
        <span class="n">time</span><span class="o">.</span><span class="n">sleep</span><span class="p">(</span><span class="n">SLEEP</span><span class="p">)</span>
</pre></div>


<p>First, always make sure <strong>you are not violating terms of use</strong> defined by service provider. If you are not, here are the necessary steps:</p>
<ol>
<li>Define your area of interest with bottom left and top right coordinates.</li>
<li>Calculate width of single image both in pixels and units of CRS to get the rightsized image. Note that there may be image size restrictions defined by provider (2048 &times; 2048 px is usually the biggest you can get).</li>
<li>Define template <a href="https://en.wikipedia.org/wiki/World_file">world file</a> for referencing images. OWSLib doesn't provide world files to saved images, these have to be created by you. I recommend to use a template file for creating real world files.</li>
<li>Be nice! Don't overload the service. I use <code>time.sleep()</code> for this.</li>
<li>Profit.</li>
</ol>
<p>The trouble with WMS is that you can't set an arbitrary scale you want to obtain images in (e.g. 1:1 000). It's fairly easy to get all values needed to imitate this behavior though.</p>
<p>Using <a href="http://qgis.org">QGIS</a> you can:</p>
<ol>
<li>Get bounding box of area you're interested in.</li>
<li>Save current view as an image (together with the world file!) and use it as a specimen for your own world files.</li>
<li>Derive image width (CRS, pixels) from the saved image, thus getting the same zoom level you were using in QGIS.</li>
</ol>
<p>Code given is not bulletproof, it will fail on any network error. However, if you restart it after such a crash, it checks for existing files and starts with the first missing, so you don't have to download all the tiles again.</p>
        </section>
        </div>
    </div>

<div class="pagination">
    <p class="paginator">
    </p>
</div>            </div>
        </div>
        <div class="row">
            <div class="large-12 columns footer">
                <footer>
                    <address>
                    Written by <a href="http://www.zimmi.cz">Michal Zimmermann</a>.
                    Proudly powered by <a href="http://getpelican.com/">Pelican</a>,
                    which takes great advantage of <a href="http://python.org">Python</a>.
                    </address><!-- /#about -->
                </footer><!-- /#contentinfo -->
            </div>
        </div>
    <script type="text/javascript">
    var _gaq = _gaq || [];
    _gaq.push(['_setAccount', 'UA-43432739-2']);
    _gaq.push(['_trackPageview']);
    (function() {
        var ga = document.createElement('script'); ga.type = 'text/javascript'; ga.async = true;
        ga.src = ('https:' == document.location.protocol ? 'https://ssl' : 'http://www') + '.google-analytics.com/ga.js';
        var s = document.getElementsByTagName('script')[0]; s.parentNode.insertBefore(ga, s);
    })();
    </script>
</body>
</html>